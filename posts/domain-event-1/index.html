<!DOCTYPE html><html lang="ko" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="[Spring] Spring boot에서 Domain Event 활용해 도메인 간의 결합도 낮추기" /><meta property="og:locale" content="ko" /><meta name="description" content="Spring boot에서 Domain Event 활용해 도메인 간의 결합도 낮추기" /><meta property="og:description" content="Spring boot에서 Domain Event 활용해 도메인 간의 결합도 낮추기" /><link rel="canonical" href="https://choieungi.github.io/posts/domain-event-1/" /><meta property="og:url" content="https://choieungi.github.io/posts/domain-event-1/" /><meta property="og:site_name" content="Ruggy Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-11-13T12:55:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[Spring] Spring boot에서 Domain Event 활용해 도메인 간의 결합도 낮추기" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-11-13T12:55:00+09:00","datePublished":"2022-11-13T12:55:00+09:00","description":"Spring boot에서 Domain Event 활용해 도메인 간의 결합도 낮추기","headline":"[Spring] Spring boot에서 Domain Event 활용해 도메인 간의 결합도 낮추기","mainEntityOfPage":{"@type":"WebPage","@id":"https://choieungi.github.io/posts/domain-event-1/"},"url":"https://choieungi.github.io/posts/domain-event-1/"}</script><title>[Spring] Spring boot에서 Domain Event 활용해 도메인 간의 결합도 낮추기 | Ruggy Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ruggy Blog"><meta name="application-name" content="Ruggy Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://avatars.githubusercontent.com/u/70755947?v=4 " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ruggy Blog</a></div><div class="site-subtitle font-italic">Growth Process as Developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/choieungi" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/eungi-choi-a8565620b" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['choieungi','gm.gist.ac.kr'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[Spring] Spring boot에서 Domain Event 활용해 도메인 간의 결합도 낮추기</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[Spring] Spring boot에서 Domain Event 활용해 도메인 간의 결합도 낮추기</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/Choieungi">Eungi, Choi</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1668311700" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-11-13 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2039 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><h1 id="spring-boot에서-domain-event-활용해-도메인-간의-결합도-낮추기">Spring boot에서 Domain Event 활용해 도메인 간의 결합도 낮추기</h1><h3 id="goal"><span class="mr-2">Goal</span><a href="#goal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>업적 달성 시, 데이터베이스에 유저의 업적 달성을 기록한다.<li>업적 달성은 편지 송신, 좋아요와 같은 유저의 행위가 발생한 후 조건을 만족하면 이뤄진다.<li>본 글에서는 유저가 편지를 작성할 떄, 이벤트를 발행해 유저의 업적을 달성하는 상황에 대한 코드를 다룹니다.</ul><h3 id="solution"><span class="mr-2">Solution</span><a href="#solution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>도메인 이벤트를 활용해 업적 조건을 만족시키는 것을 이벤트 리스너로 추적한다. 이를 통해 서로 다른 도메인의 결합도를 낮춘다.</ul><h3 id="문제-상황"><span class="mr-2">문제 상황</span><a href="#문제-상황" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>업적 달성은 데이터베이스의 유저의 정보 변경이 일어날 때 발생한다. 이는 곧, 유저 테이블에서 Insert와 Update 작업이 발생할 때, 업적 달성이 이뤄진다. 그렇기에 이 작업들에 대해 추적을 해야할 것이다. 여러가지 방법이 존재하겠지만, 이를 코드에서 추적할 수 있다면 좋겠다고 생각했고, 본 프로젝트에서는 Spring data를 사용하고 있어 관련된 해결책을 모색했다.</p><p>가장 첫 번째로 생각이 들었던건 단순히 비즈니스 로직을 처리하는 서비스 레이어에서 업적이 일어날 때마다 분기를 넣어 해결하는 방법인데, 이는 서로 다른 도메인의 강결합이 일어나는 문제가 존재했다. 편지 서비스 계층에서 편지 도메인의 편지라는 엔티티가 생성될 때, 유저 도메인의 유저 업적 엔티티를 생성하게 된다면 편지 도메인과 유저 업적 도메인이 강결합을 갖게 된다. 이렇게 다른 컨텍스트에 존재하는 도메인의 결합이 된다면, 추후 편지 작성이 아닌 다른 도메인에 해당하는 행위에 대한 업적을 생성할 때도 해당하는 엔티티와 유저 업적 엔티티는 강결합을 갖게 된다. 이는 극단적으로 유저 도메인과 다른 모든 도메인이 의존관계를 갖게 되는 잠재적 위험성이 있다.</p><p>그렇기 때문에 이러한 결합을 끊고, 스프링에서 제공하는 좋은 기능인 Domain Event를 발행해 해결한 사례를 공유합니다.</p><h3 id="domain-event란"><span class="mr-2">Domain Event란?</span><a href="#domain-event란" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>도메인 객체에서 어떤 작업이 실행됬을 때, 발행할 수 있는 이벤트를 의미한다. 이를 통해 객체의 생성이나 변경을 다른 객체와 결합 없이 Event Linstener를 통해 추적할 수 있다. 이를 통해 얻을 수 있는 장점은 다음과 같다.</p><ul><li>서로 다른 도메인 로직이 섞일 일이 없다.<li>확장할 때 발행한 이벤트에 대해 추적하는 Listener만 추가해주면 되기 때문에 확장에 용이하다.<li>이벤트 발생 이후의 작업(이벤트 리스너의 작업)을 비동기로 처리할 수 있다.</ul><p>스프링에서 기본적으로 제공하는 <a href="https://www.baeldung.com/spring-events#:~:text=And%20like%20many%20other%20things%20in%20Spring%2C%20event%20publishing%20is%20one%20of%20the%20capabilities%20provided%20by%20ApplicationContext.">ApplicationContext는 이벤트를 발행할 수 있기 때문에</a>, 이를 활용해 만들어진 도메인 이벤트를 활용하는데 어렵지 않게 사용할 수 있다.</p><h2 id="코드"><span class="mr-2">코드</span><a href="#코드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="aggregateroot"><span class="mr-2">AggregateRoot<a></a></span><a href="#aggregateroot" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>먼저, spring data에서 제공하는 <code class="language-plaintext highlighter-rouge">AbstractAggregateRoot&lt;A&gt;</code> 를 활용한다면, 도메인 이벤트를 어렵지 않게 구현할 수 있다. <code class="language-plaintext highlighter-rouge">AbstractAggregateRoot</code> 는 domain event를 간편하게 발행할 수 있도록 만든 모듈이다. 이는 이름에서 볼 수 있듯, 도메인 이벤트를 발행하는 주체는 DDD의 AggregateRoot가 된다는 의미를 내포하고 있다.</p><p>Aggregate는 관련 객체를 하나로 묶은 군집을 의미하며, AggregateRoot는 군집 내에서 여러 객체들을 관리하는 루트 엔티티이다. 일반적으로 하나의 엔티티와 여러 개의 Value Object(값 객체)를 지니고 있으며, 하나의 Aggregate에 속한 객체는 같은 라이프사이클을 지닌다. Aggregate를 통해 간의 관계를 확인한다면, 더 상위 수준에서 도메인 간의 관계를 파악하는데 수월해진다.</p><p>본론으로 <code class="language-plaintext highlighter-rouge">AbstractAggregateRoot&lt;A&gt;</code> 를 이벤트를 발행할 Entity에 상속시키면 된다. 여기서 제너릭 타입(<code class="language-plaintext highlighter-rouge">&lt;A&gt;</code>)은 Entity의 타입이 된다. 이를 통해 <code class="language-plaintext highlighter-rouge">registerEvent(event)</code> 메소드를 상속받을 수 있으며 이 메소드를 통해 이벤트를 등록할 수 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AbstractAggregateRoot</span><span class="o">&lt;</span><span class="no">A</span> <span class="kd">extends</span> <span class="nc">AbstractAggregateRoot</span><span class="o">&lt;</span><span class="no">A</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">transient</span> <span class="kd">final</span> <span class="nd">@Transient</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">domainEvents</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

	<span class="cm">/**
	 * Registers the given event object for publication on a call to a Spring Data repository's save methods.
	 *
	 * @param event must not be {@literal null}.
	 * @return the event that has been added.
	 * @see #andEvent(Object)
	 */</span>
	<span class="kd">protected</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">registerEvent</span><span class="o">(</span><span class="no">T</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>

		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="s">"Domain event must not be null!"</span><span class="o">);</span>

		<span class="k">this</span><span class="o">.</span><span class="na">domainEvents</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">event</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="o">...</span>
<span class="o">}</span>
</pre></table></code></div></div><p>이를 통해 편지 도메인 코드에 반영을 하면, 다음과 같다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@NoArgsConstructor</span><span class="o">(</span><span class="n">access</span> <span class="o">=</span> <span class="nc">AccessLevel</span><span class="o">.</span><span class="na">PROTECTED</span><span class="o">)</span>
<span class="nd">@Getter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Letter</span> <span class="kd">extends</span> <span class="nc">AbstractAggregateRoot</span><span class="o">&lt;</span><span class="nc">Letter</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Lob</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">content</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">LocalDate</span> <span class="n">sendDate</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isRead</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">User</span> <span class="n">sender</span><span class="o">;</span>

		<span class="o">...</span>

		<span class="nd">@PostPersist</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">created</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">registerEvent</span><span class="o">(</span><span class="k">new</span> <span class="nc">LetterCreatedEvent</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">sender</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">sender</span><span class="o">.</span><span class="na">getUserAchievement</span><span class="o">().</span><span class="na">getSendLetterCountValue</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">receiver</span><span class="o">.</span><span class="na">getReceiveCount</span><span class="o">()));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>여기서 <code class="language-plaintext highlighter-rouge">@PostPersist</code> 를 통해 이벤트를 발행했는데, 이는 JPA 엔티티의 라이프사이클에서 영속화가 된 이후에 이벤트를 등록하려 했기 때문에 다음과 같이 진행했다. 이는 서비스 계층에서 특별히 호출을 안해도 될 뿐더러, PK값 정책이 IDENTITY이기 때문에 영속화가 된 이후에 키 값을 받은 상태로 이벤트를 발행할 수 있다.</p><h3 id="eventlistener"><span class="mr-2">@EventListener</span><a href="#eventlistener" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><code class="language-plaintext highlighter-rouge">@EventListener</code>를 통해 선언적으로 이벤트를 처리할 수 있다. 이를 통해 이벤트를 받는 코드를 작성하면 다음과 같다. 뿐만 아니라, 특정 조건을 만족하려 한다면 <code class="language-plaintext highlighter-rouge">@EventListener(condition)</code> 을 사용한다면 간편하게 활용할 수 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AchievementPolicy</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AchievementRepository</span> <span class="n">achievementRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">LetterRepository</span> <span class="n">letterRepository</span><span class="o">;</span>

    <span class="o">...</span>

    <span class="nd">@EventListener</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">achieveLevelTwo</span><span class="o">(</span><span class="nc">LetterCreatedEvent</span> <span class="n">letterCreatedEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Long</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">letterCreatedEvent</span><span class="o">.</span><span class="na">getUserId</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">existsById</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">letterRepository</span><span class="o">.</span><span class="na">existsById</span><span class="o">(</span><span class="n">letterCreatedEvent</span><span class="o">.</span><span class="na">getId</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">achievementRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Achievement</span><span class="o">(</span><span class="no">LEVEL_TWO</span><span class="o">.</span><span class="na">getLevel</span><span class="o">(),</span> <span class="no">LEVEL_TWO</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="no">LEVEL_TWO</span><span class="o">.</span><span class="na">getTag</span><span class="o">(),</span> <span class="n">userId</span><span class="o">));</span>
            <span class="n">userRepository</span><span class="o">.</span><span class="na">increaseUserPoint</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="no">LEVEL_TWO</span><span class="o">.</span><span class="na">getPoint</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@EventListener</span><span class="o">(</span><span class="n">condition</span> <span class="o">=</span> <span class="s">"#letterReadEvent.read == true"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">achieveLevelThree</span><span class="o">(</span><span class="nc">LetterReadEvent</span> <span class="n">letterReadEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Long</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">letterReadEvent</span><span class="o">.</span><span class="na">getUserId</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">existsById</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">letterRepository</span><span class="o">.</span><span class="na">existsById</span><span class="o">(</span><span class="n">letterReadEvent</span><span class="o">.</span><span class="na">getId</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">achievementRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Achievement</span><span class="o">(</span><span class="no">LEVEL_THREE</span><span class="o">.</span><span class="na">getLevel</span><span class="o">(),</span> <span class="no">LEVEL_THREE</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="no">LEVEL_THREE</span><span class="o">.</span><span class="na">getTag</span><span class="o">(),</span> <span class="n">userId</span><span class="o">));</span>
            <span class="n">userRepository</span><span class="o">.</span><span class="na">increaseUserPoint</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="no">LEVEL_THREE</span><span class="o">.</span><span class="na">getPoint</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="테스트"><span class="mr-2">테스트</span><a href="#테스트" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>이벤트 발행에 대한 테스트는 <code class="language-plaintext highlighter-rouge">@*RecordApplicationEvents*</code> 옵션을 활용할 수 있다. 이는 단일 테스트 실행 시 발행되는 어플리케이션 이벤트를 <code class="language-plaintext highlighter-rouge">ApplicationEvents</code> 라는 객체에 저장된다. <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/test/context/event/RecordApplicationEvents.html">공식 문서</a>에는 다음과 같이 나타나 있다.</p><blockquote><p>@RecordApplicationEvents is a class-level annotation that is used to instruct the Spring TestContext Framework to record all application events that are published in the ApplicationContext during the execution of a single test. The recorded events can be accessed via the ApplicationEvents API within your tests.</p></blockquote><p>이에 대한 코드를 작성하면 다음과 같다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="nd">@RecordApplicationEvents</span>
<span class="nd">@SpringBootTest</span>
<span class="nd">@ActiveProfiles</span><span class="o">(</span><span class="s">"test"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LetterEventTest</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">ApplicationEvents</span> <span class="n">applicationEvents</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">LetterService</span> <span class="n">letterService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">User</span> <span class="n">sender</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">User</span> <span class="n">receiver</span><span class="o">;</span>

    <span class="nd">@BeforeEach</span>
    <span class="kt">void</span> <span class="nf">setup</span><span class="o">(){</span>
        <span class="n">sender</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="nc">Fixtures</span><span class="o">.</span><span class="na">UserStub</span><span class="o">.</span><span class="na">defaultGoogleUser</span><span class="o">(</span><span class="s">"gmail@gmail.com"</span><span class="o">));</span>
        <span class="n">receiver</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="nc">Fixtures</span><span class="o">.</span><span class="na">UserStub</span><span class="o">.</span><span class="na">defaultGoogleUser</span><span class="o">(</span><span class="s">"receiver@gmail.com"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">letter_created_event_test</span><span class="o">(){</span>
        <span class="n">letterService</span><span class="o">.</span><span class="na">writeLetter</span><span class="o">(</span><span class="k">new</span> <span class="nc">LetterRequest</span><span class="o">(</span><span class="s">"content"</span><span class="o">,</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">()),</span> <span class="n">sender</span><span class="o">);</span>
        <span class="n">letterService</span><span class="o">.</span><span class="na">writeLetter</span><span class="o">(</span><span class="k">new</span> <span class="nc">LetterRequest</span><span class="o">(</span><span class="s">"content"</span><span class="o">,</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">()),</span> <span class="n">sender</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">applicationEvents</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="nc">LetterCreatedEvent</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">count</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>하나의 편지를 작성할 떄(DB에 편지를 저장할 떄) 정상적으로 이벤트가 발행되는 것을 볼 수 있다.</p><h3 id="아쉬운-점"><span class="mr-2">아쉬운 점</span><a href="#아쉬운-점" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>현재 EventListener 내 작업은 트렌젝션이 보장되어야 한다. 이에 대해 이벤트 리스너의 트랜잭션을 어떻게 처리할 지 알아보면 좋을 듯 싶다.</p><h3 id="레퍼런스"><span class="mr-2">레퍼런스</span><a href="#레퍼런스" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><a href="https://www.baeldung.com/spring-data-ddd"></a></p><p><a href="https://www.baeldung.com/jpa-entity-lifecycle-events"></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/development/'>Development</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring/" class="post-tag no-text-decoration" >Spring</a> <a href="/tags/sw-%EB%A7%88%EC%97%90%EC%8A%A4%ED%8A%B8%EB%A1%9C/" class="post-tag no-text-decoration" >SW 마에스트로</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[Spring] Spring boot에서 Domain Event 활용해 도메인 간의 결합도 낮추기 - Ruggy Blog&amp;url=https://choieungi.github.io/posts/domain-event-1/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[Spring] Spring boot에서 Domain Event 활용해 도메인 간의 결합도 낮추기 - Ruggy Blog&amp;u=https://choieungi.github.io/posts/domain-event-1/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://choieungi.github.io/posts/domain-event-1/&amp;text=[Spring] Spring boot에서 Domain Event 활용해 도메인 간의 결합도 낮추기 - Ruggy Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/spring-boot-cahce-error-handling/">Spring Boot에서 CacheManager를 에러 핸들링하는 방법</a><li><a href="/posts/spring-cloud-refresh/">분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법</a><li><a href="/posts/spring-redis-distributed-lock/">Spring MVC에서 redisson으로 분산락을 구현하는 방법들</a><li><a href="/posts/spring-redis-cache-serialization-exception/">Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점</a><li><a href="/posts/querydsl-connection-leak/">querydsl의 transform 메서드에서 발생하는 connection leak 현상</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spring-boot/">Spring Boot</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/thinking/">Thinking</a> <a class="post-tag" href="/tags/redis/">Redis</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/development/">Development</a> <a class="post-tag" href="/tags/gist-%EC%B2%AD%EC%9B%90/">GIST 청원</a> <a class="post-tag" href="/tags/git/">Git</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/spring/">Spring</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/querydsl-connection-leak/"><div class="card-body"> <em class="timeago small" data-ts="1678631400" > 2023-03-12 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>querydsl의 transform 메서드에서 발생하는 connection leak 현상</h3><div class="text-muted small"><p> 문제 상황 회사에서 모든 환불은 어드민 서버를 거쳐 환불 서버에 환불 요청을 보내 환불 프로세스가 진행된다. 하지만 환불 서버에서 요청을 제대로 보내고 환불을 완료했지만, 어드민 서버에서 히스토리를 DB에 기록하는 작업이 제대로 이뤄지지 않았다. 그렇기에 어드민 히스토리와 환불 기록의 불일치가 발생했고, 이 운영 이슈를 해결하는 과정을 남기려고 한다...</p></div></div></a></div><div class="card"> <a href="/posts/amazon-aurora-storage-with-innodb/"><div class="card-body"> <em class="timeago small" data-ts="1681051500" > 2023-04-09 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Amazon Aurora 스토리지 엔진과 MySQL InnoDB 스토리지 엔진 비교</h3><div class="text-muted small"><p> 우리 회사를 포함해 많은 회사는 RDBMS를 사용할 때 MySQL Amazon Aurora DB(이하 오로라)를 사용하는 경우가 존재한다. 왜 오로라를 사용하는 지 궁금했는데 기존 전통적인 MySQL보다 가용성, 확장성, 연산 비용 등이 더 싸서 대규모 처리 작업에 용이해서 사용한다고 들었다. 또, 오로라는 컴퓨팅과 스토리지 인스턴스가 각각 분리되어 ...</p></div></div></a></div><div class="card"> <a href="/posts/mysql-resources/"><div class="card-body"> <em class="timeago small" data-ts="1689518940" > 2023-07-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MySQL 커넥션, I/O 연산, 잠금에 대한 고찰</h3><div class="text-muted small"><p> 실무에서 MySQL 데이터베이스를 활용하면서 커넥션, I/O 연산, 잠금에 대해 더 유심히 살펴보게 되었다. 요 세가지 자원이 중요하다고 배웠는데 실제로 사용해보면서 정말 그렇다는걸 느낄 수 있었다. 그렇기에 이를 통해 배운점들을 다시 상기해고자 한다. 커넥션 데이터베이스를 사용하면서 가장 중요한 자원을 꼽는다면 커넥션이다. 커넥션이 부족해지는 순...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Mocking-test/" class="btn btn-outline-primary" prompt="Older"><p>[Testing] Mockito를 이용한 Service Layer Unit Testing</p></a> <a href="/posts/%EC%A4%91%EC%9A%94%ED%95%9C-%EC%9D%BC%EC%97%90-%EC%A7%91%EC%A4%91%ED%95%98%EA%B8%B0/" class="btn btn-outline-primary" prompt="Newer"><p>중요한 일에 집중하기</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/Choieungi">Eungi, Choi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spring-boot/">Spring Boot</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/thinking/">Thinking</a> <a class="post-tag" href="/tags/redis/">Redis</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/development/">Development</a> <a class="post-tag" href="/tags/gist-%EC%B2%AD%EC%9B%90/">GIST 청원</a> <a class="post-tag" href="/tags/git/">Git</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/spring/">Spring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-3R6NSQ6EMQ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-3R6NSQ6EMQ'); }); </script>
