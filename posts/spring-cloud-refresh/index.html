<!DOCTYPE html><html lang="ko" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법" /><meta property="og:locale" content="ko" /><meta name="description" content="근래에 요즘 우아한 개발이라는 책을 읽으면서 내용 중에 배포 없이 Spring Cloud Config에서 받아오는 프로퍼티를 변경해 서버에 적용하려는 내용을 접했습니다. 해당 팀은 외부 메시지 플랫폼을 이중화하면서 각 외부 플랫폼 연동에 대한 트래픽 분배를 어플리케이션 실행 중에도 변경할 수 있도록 구현해 단일 장애 지점(SPOF)을 제거하려 했습니다. 이를 위해 어플리케이션의 배포 없이 Config 서버의 프로퍼티를 변경함으로 트래픽 분배를 변경하는 방법을 고려했고, 팀에서 최종적으로 일반적으로 사용하는 Spring Cloud Bus를 이용하기보다 Spring Boot만을 활용해 프로퍼티를 재배포 없이 수정하는 방법을 선택했습니다. 이 부분이 흥미롭게 느껴져 호기심에 구현해보게 되었습니다." /><meta property="og:description" content="근래에 요즘 우아한 개발이라는 책을 읽으면서 내용 중에 배포 없이 Spring Cloud Config에서 받아오는 프로퍼티를 변경해 서버에 적용하려는 내용을 접했습니다. 해당 팀은 외부 메시지 플랫폼을 이중화하면서 각 외부 플랫폼 연동에 대한 트래픽 분배를 어플리케이션 실행 중에도 변경할 수 있도록 구현해 단일 장애 지점(SPOF)을 제거하려 했습니다. 이를 위해 어플리케이션의 배포 없이 Config 서버의 프로퍼티를 변경함으로 트래픽 분배를 변경하는 방법을 고려했고, 팀에서 최종적으로 일반적으로 사용하는 Spring Cloud Bus를 이용하기보다 Spring Boot만을 활용해 프로퍼티를 재배포 없이 수정하는 방법을 선택했습니다. 이 부분이 흥미롭게 느껴져 호기심에 구현해보게 되었습니다." /><link rel="canonical" href="https://choieungi.github.io/posts/spring-cloud-refresh/" /><meta property="og:url" content="https://choieungi.github.io/posts/spring-cloud-refresh/" /><meta property="og:site_name" content="Ruggy Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-01-21T16:12:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-01-21T22:50:10+09:00","datePublished":"2024-01-21T16:12:00+09:00","description":"근래에 요즘 우아한 개발이라는 책을 읽으면서 내용 중에 배포 없이 Spring Cloud Config에서 받아오는 프로퍼티를 변경해 서버에 적용하려는 내용을 접했습니다. 해당 팀은 외부 메시지 플랫폼을 이중화하면서 각 외부 플랫폼 연동에 대한 트래픽 분배를 어플리케이션 실행 중에도 변경할 수 있도록 구현해 단일 장애 지점(SPOF)을 제거하려 했습니다. 이를 위해 어플리케이션의 배포 없이 Config 서버의 프로퍼티를 변경함으로 트래픽 분배를 변경하는 방법을 고려했고, 팀에서 최종적으로 일반적으로 사용하는 Spring Cloud Bus를 이용하기보다 Spring Boot만을 활용해 프로퍼티를 재배포 없이 수정하는 방법을 선택했습니다. 이 부분이 흥미롭게 느껴져 호기심에 구현해보게 되었습니다.","headline":"분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법","mainEntityOfPage":{"@type":"WebPage","@id":"https://choieungi.github.io/posts/spring-cloud-refresh/"},"url":"https://choieungi.github.io/posts/spring-cloud-refresh/"}</script><title>분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법 | Ruggy Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ruggy Blog"><meta name="application-name" content="Ruggy Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://avatars.githubusercontent.com/u/70755947?v=4 " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ruggy Blog</a></div><div class="site-subtitle font-italic">Growth Process as Developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/choieungi" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/eungi-choi-a8565620b" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['choieungi','gm.gist.ac.kr'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/Choieungi">Eungi, Choi</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1705821120" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-01-21 </em> </span> <span> Updated <em class="timeago" data-ts="1705845010" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-01-21 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3262 words"> <em>18 min</em> read</span></div></div></div><div class="post-content"><p>근래에 <a href="https://m.yes24.com/Goods/Detail/122535338">요즘 우아한 개발</a>이라는 책을 읽으면서 내용 중에 배포 없이 Spring Cloud Config에서 받아오는 프로퍼티를 변경해 서버에 적용하려는 내용을 접했습니다. 해당 팀은 <a href="https://techblog.woowahan.com/7724/">외부 메시지 플랫폼을 이중화</a>하면서 각 외부 플랫폼 연동에 대한 트래픽 분배를 어플리케이션 실행 중에도 변경할 수 있도록 구현해 단일 장애 지점(SPOF)을 제거하려 했습니다.<br /> 이를 위해 어플리케이션의 배포 없이 Config 서버의 프로퍼티를 변경함으로 트래픽 분배를 변경하는 방법을 고려했고, 팀에서 최종적으로 일반적으로 사용하는 Spring Cloud Bus를 이용하기보다 Spring Boot만을 활용해 프로퍼티를 재배포 없이 수정하는 방법을 선택했습니다. 이 부분이 흥미롭게 느껴져 호기심에 구현해보게 되었습니다.</p><h3 id="배포-없이-프로퍼티를-변경하는-방법-refresh"><span class="mr-2">배포 없이 프로퍼티를 변경하는 방법, refresh</span><a href="#배포-없이-프로퍼티를-변경하는-방법-refresh" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Spring Boot를 이용하면 로깅 레벨, 데이터 소스 정보, 타임아웃 설정, 환경 변수 등 여러 설정 정보(이하 프로퍼티)를 application.yml 혹은 application.properties 파일에 명시해서 외부화(externalize)할 수 있습니다. 이를 통해 다양한 환경(local, dev, prod 등) 설정을 코드가 아닌 외부 파일에 명시함으로 해당 관심사를 코드에서 분리할 수 있습니다.</p><p>책에 나온 사례와 같이 외부 시스템 장애와 같은 기민한 대응을 하려면 어플리케이션 배포 없이도 런타임 환경에서 변경할 수 있어야 합니다. 만약 해당 기능이 비즈니스에서 중요한 역할을 하는 부분이라면 더더욱 조심스럽고 기민하게 다뤄야 합니다.</p><p>Spring Cloud Config 프로퍼티를 직접 클라우드 서비스에 올려 사용할 수 있도록 해줍니다. 이를 이용하면 Cloud Config 서버를 호출해서 스프링 프로퍼티값을 받아올 수 있습니다. 또 Cloud Config를 이용하면 <code class="language-plaintext highlighter-rouge">@RefreshScope</code> 빈을 손쉽게 reload할 수 있게 됩니다. 간단한 예로 Spring Cloud Config 서버의 프로퍼티를 변경한 이후에 actuator에서 <code class="language-plaintext highlighter-rouge">/refresh</code> endpoint를 활성화 한 상태에서 호출하게 되면 변경된 프로퍼티 값을 받아올 수 있습니다. <a href="https://velog.io/@korea3611/Spring-Boot-Spring-Cloud-Config3-Actuator-refresh-MSA6">참고 링크</a></p><p>일반적으로 트래픽이 많은 서비스의 서버는 멀티 인스턴스 환경에서 운영됩니다. 여기서 모든 인스턴스의 Config 프로퍼티는 동일해야 하며, 이를 api 호출로는 하나의 인스턴스 밖에 Config 프로퍼티 변경이 안되고 이는 서버마다 설정값이 달라지게 됩니다.</p><p><img data-src="https://i.imgur.com/n9s2Nsg.png" alt="" data-proofer-ignore></p><p>이러한 문제를 해결하기 위해 Spring Cloud Bus를 통해 멀티 인스턴스 환경에서도 프로퍼티를 Refresh할 수 있습니다. 간략하게 소개하면 Config Server의 프로퍼티에 변경이 감지되면 Kafka, Redis, AMQP 중 하나를 이용해 변경된 프로퍼티 사용하는 모든 서버에 전달하는 역할을 합니다.</p><p>다만 Spring Cloud Bus 라이브러리는 Kafka, Redis, AMQP를 사용해 외부 인프라 의존성을 가지게 되고 해당 인프라 상태가 정상적이지 않을 때 사용하기 어렵습니다.</p><p>이를 해결하기 위해서 책에서는 Spring Cloud Config + Scheduled Polling을 이용한 아키텍처를 제안합니다. 외부 인프라를 관리하는 비용이 없다는 장점이 있습니다. 이를 구현해보도록 해보면 다음과 같습니다. <img data-src="https://i.imgur.com/aU4A4Av.png" alt="" data-proofer-ignore></p><p>이제 코드를 통해 살펴보도록 하겠습니다.</p><h3 id="schedule-와-conteextrefresher를-이용해-구현"><span class="mr-2"><code class="language-plaintext highlighter-rouge"><span class="mr-2">@Schedule</code> 와 ConteextRefresher를 이용해 구현</span><a href="#schedule-와-conteextrefresher를-이용해-구현" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@ConditionalOnProperty</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"application.config.refresh.auto.enabled"</span><span class="o">,</span> <span class="n">havingValue</span> <span class="o">=</span> <span class="s">"true"</span><span class="o">,</span> <span class="n">matchIfMissing</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfigRefreshScheduler</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ContextRefresher</span> <span class="n">contextRefresher</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TestValueProperties</span> <span class="n">testValueProperties</span><span class="o">;</span>

  <span class="nd">@Scheduled</span><span class="o">(</span><span class="n">fixedDelay</span> <span class="o">=</span> <span class="mi">5L</span><span class="o">,</span> <span class="n">timeUnit</span> <span class="o">=</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
  <span class="nd">@Async</span><span class="o">(</span><span class="s">"refreshThreadPoolExecutor"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">refreshConfig</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">refreshedKeys</span> <span class="o">=</span> <span class="n">contextRefresher</span><span class="o">.</span><span class="na">refreshEnvironment</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(!</span><span class="nc">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">refreshedKeys</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[Refreshed] "</span> <span class="o">+</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">","</span><span class="o">,</span> <span class="n">refreshedKeys</span><span class="o">));</span>
        <span class="n">contextRefresher</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Changed value: {}"</span><span class="o">,</span> <span class="n">testValueProperties</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"config refresh failed {}"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@ConditionalOnBean</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">ConfigRefreshScheduler</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">ThreadPoolTaskExecutor</span> <span class="nf">refreshThreadPoolExecutor</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ThreadPoolTaskExecutor</span> <span class="n">threadPoolTaskExecutor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskExecutor</span><span class="o">();</span>
    <span class="n">threadPoolTaskExecutor</span><span class="o">.</span><span class="na">setThreadNamePrefix</span><span class="o">(</span><span class="s">"refresh"</span><span class="o">);</span>
    <span class="n">threadPoolTaskExecutor</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">threadPoolTaskExecutor</span><span class="o">.</span><span class="na">setMaxPoolSize</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">threadPoolTaskExecutor</span><span class="o">.</span><span class="na">setQueueCapacity</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
    <span class="n">threadPoolTaskExecutor</span><span class="o">.</span><span class="na">initialize</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">threadPoolTaskExecutor</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">"my"</span><span class="o">)</span>
  <span class="nd">@Configuration</span>
  <span class="nd">@Getter</span>
  <span class="nd">@Setter</span>
  <span class="nd">@RefreshScope</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TestValueProperties</span> <span class="o">{</span>

    <span class="c1">// get my.value from config properties</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">value</span><span class="o">;</span>

    <span class="nd">@PostConstruct</span>
    <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"-------------------------------- my properties value --------------------------------"</span><span class="o">);</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"{} Bean Loaded"</span><span class="o">,</span> <span class="nc">TestValueProperties</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"-------------------------------- my properties value --------------------------------"</span><span class="o">);</span>
    <span class="o">}</span>

  <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><p>해당 코드는 5초마다 Config Server의 프로퍼티와 서버의 프러퍼티를 비교해 변경된 프로퍼티가 있으면 <code class="language-plaintext highlighter-rouge">@RefreshScope</code> 빈(<code class="language-plaintext highlighter-rouge">TestValueProperties</code>)을 초기화하는 코드입니다. <code class="language-plaintext highlighter-rouge">TestProperties</code>는 Config Server에서 <code class="language-plaintext highlighter-rouge">my.value</code>라는 프로퍼티 값을 바인딩하는 빈입니다.</p><p>refresh에서 중요한 역할을 하는 <code class="language-plaintext highlighter-rouge">ContextRefresher</code>를 간략하게 살펴보면 <code class="language-plaintext highlighter-rouge">refreshEnvironment()</code>는 빈을 refresh하지 않으며, config 설정만 refresh하고 이로 인해 변경된 config의 key값을 리턴합니다. <code class="language-plaintext highlighter-rouge">refresh()</code>의 경우 <code class="language-plaintext highlighter-rouge">refreshEnvironment()</code> 을 먼저 호출해서 config를 spring conetext에 저장하며 그 이후 <code class="language-plaintext highlighter-rouge">@RefreshScope</code> 빈을 모두 refresh하고 변경된 config의 key값을 리턴합니다.</p><p>실제로 서버를 구동하면 다음 값을 가지고 있습니다. <img data-src="https://i.imgur.com/jgKFt6l.png" alt="" data-proofer-ignore></p><p>이후 config Server 값을 변경하면 다음과 같습니다. <img data-src="https://i.imgur.com/Gd7yzEQ.png" alt="" data-proofer-ignore></p><p>만약 Config Server의 yml 형식이 잘못되었거나 config 서버에 이상이 생긴다면 다음과 같은 에러 로그가 발생합니다. 이는 프로퍼티를 원활히 받아오지 못했기에 기존에 정상적으로 받아온 프로퍼티로 서비스가 운영되게 됩니다. <img data-src="https://i.imgur.com/6bUmP6y.png" alt="" data-proofer-ignore></p><p>이제 <code class="language-plaintext highlighter-rouge">ContextRefresher</code> 내부 코드를 통해 더 구체적인 동작 원리를 알아보겠습니다.</p><h3 id="context-refresher-원리"><span class="mr-2">Context Refresher 원리</span><a href="#context-refresher-원리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>ContextRefresher은 Config 서버에서 받아와 API 서버 프로퍼티를 Refresh하거나 RefreshScope 빈을 Refresh하는 역할을 합니다. ContextRefresher는 Spring Cloud Client 라이브러리 의존성을 추가하면 <code class="language-plaintext highlighter-rouge">RefreshAutoConfiguration</code>으로 인해 자동으로 빈으로 등록됩니다. 다음 코드를 보면 알 수 있듯 <code class="language-plaintext highlighter-rouge">spring.cloud.bootstrap.enabled: true</code> 면 <code class="language-plaintext highlighter-rouge">LegacyContextRefresher</code>가 빈으로 등록되고 그렇지 않으면 <code class="language-plaintext highlighter-rouge">ConfigDataContextRefresher</code>가 빈으로 등록됩니다. Spring Cloud에서 bootstrap 기본 옵션은 false이기에 <code class="language-plaintext highlighter-rouge">ConfigDataContextRefresher</code> 가 빈으로 등록됩니다. 두 차이를 간략하게 소개하면 내부 코드에서 <code class="language-plaintext highlighter-rouge">ConfigDataContextRefresher</code>는 빈 후처리기인 <code class="language-plaintext highlighter-rouge">EnvironmentPostProcessor</code>를 이용해 ApplicationContext를 Refresh하기 때문에 ApplicationContext를 전체를 refresh하는 <code class="language-plaintext highlighter-rouge">LegacyContextRefresher</code>보다 더 효율적이라고 볼 수 있습니다. 더 자세한 내용은 본 글의 주제와 벗어나 더 다루지는 않겠습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre><td class="rouge-code"><pre><span class="c1">//package org.springframework.cloud.autoconfigure.RefreshAutoConfiguration;</span>

<span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@ConditionalOnClass</span><span class="o">(</span><span class="nc">RefreshScope</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ConditionalOnProperty</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="nc">RefreshAutoConfiguration</span><span class="o">.</span><span class="na">REFRESH_SCOPE_ENABLED</span><span class="o">,</span> <span class="n">matchIfMissing</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@AutoConfigureBefore</span><span class="o">(</span><span class="nc">HibernateJpaAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="nc">RefreshAutoConfiguration</span><span class="o">.</span><span class="na">RefreshProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RefreshAutoConfiguration</span> <span class="o">{</span>

	<span class="cm">/**
	 * Name of the refresh scope name.
	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">REFRESH_SCOPE_NAME</span> <span class="o">=</span> <span class="s">"refresh"</span><span class="o">;</span>

	<span class="cm">/**
	 * Name of the prefix for refresh scope.
	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">REFRESH_SCOPE_PREFIX</span> <span class="o">=</span> <span class="s">"spring.cloud.refresh"</span><span class="o">;</span>

	<span class="cm">/**
	 * Name of the enabled prefix for refresh scope.
	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">REFRESH_SCOPE_ENABLED</span> <span class="o">=</span> <span class="no">REFRESH_SCOPE_PREFIX</span> <span class="o">+</span> <span class="s">".enabled"</span><span class="o">;</span>

	<span class="nd">@Bean</span>
	<span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="nc">RefreshScope</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">RefreshScope</span> <span class="nf">refreshScope</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">RefreshScope</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="o">...</span>

	<span class="nd">@Bean</span>
	<span class="nd">@ConditionalOnMissingBean</span>
	<span class="nd">@ConditionalOnBootstrapEnabled</span>
	<span class="kd">public</span> <span class="nc">LegacyContextRefresher</span> <span class="nf">legacyContextRefresher</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">RefreshScope</span> <span class="n">scope</span><span class="o">,</span>
			<span class="nc">RefreshProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">LegacyContextRefresher</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">scope</span><span class="o">,</span> <span class="n">properties</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Bean</span>
	<span class="nd">@ConditionalOnMissingBean</span>
	<span class="nd">@ConditionalOnBootstrapDisabled</span>
	<span class="kd">public</span> <span class="nc">ConfigDataContextRefresher</span> <span class="nf">configDataContextRefresher</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">,</span>
			<span class="nc">RefreshScope</span> <span class="n">scope</span><span class="o">,</span> <span class="nc">RefreshProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">ConfigDataContextRefresher</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">scope</span><span class="o">,</span> <span class="n">properties</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">RefreshEventListener</span> <span class="nf">refreshEventListener</span><span class="o">(</span><span class="nc">ContextRefresher</span> <span class="n">contextRefresher</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">RefreshEventListener</span><span class="o">(</span><span class="n">contextRefresher</span><span class="o">);</span>
	<span class="o">}</span>
  <span class="o">...</span>

<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">ConfigDataContextRefresher</code>는 <code class="language-plaintext highlighter-rouge">ContextRefresher</code>의 구현체입니다. ContextRefresher는 spring web actuator에서 <code class="language-plaintext highlighter-rouge">/refresh</code> endpoint를 enable할 떄 ContextRefresher를 사용해 <code class="language-plaintext highlighter-rouge">@RefreshScope</code> 빈을 refresh합니다. 실제로 spirng web actuator의 RefreshEndpoint 클래스는 다음과 같으며, <code class="language-plaintext highlighter-rouge">contextRefresher.refresh()</code>를 통해 <code class="language-plaintext highlighter-rouge">@RefreshScope</code> 빈을 refresh해주고 있습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="c1">// package org.springframework.cloud.context.refresh.ConfigDataContextRefresher;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfigDataContextRefresher</span> <span class="kd">extends</span> <span class="nc">ContextRefresher</span>
		<span class="kd">implements</span> <span class="nc">ApplicationListener</span><span class="o">&lt;</span><span class="nc">ApplicationPreparedEvent</span><span class="o">&gt;</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="nc">SpringApplication</span> <span class="n">application</span><span class="o">;</span>

	<span class="nd">@Deprecated</span>
	<span class="kd">public</span> <span class="nf">ConfigDataContextRefresher</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">RefreshScope</span> <span class="n">scope</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">scope</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">ConfigDataContextRefresher</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">RefreshScope</span> <span class="n">scope</span><span class="o">,</span>
			<span class="nc">RefreshAutoConfiguration</span><span class="o">.</span><span class="na">RefreshProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">scope</span><span class="o">,</span> <span class="n">properties</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="nc">ApplicationPreparedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">application</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getSpringApplication</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">updateEnvironment</span><span class="o">()</span> <span class="o">{</span>
	  <span class="o">...</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c1">// package org.springframework.cloud.endpoint.RefreshEndpoint</span>

<span class="nd">@Endpoint</span><span class="o">(</span><span class="n">id</span> <span class="o">=</span> <span class="s">"refresh"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RefreshEndpoint</span><span class="o">{</span>

	<span class="kd">private</span> <span class="nc">ContextRefresher</span> <span class="n">contextRefresher</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">RefreshEndpoint</span><span class="o">(</span><span class="nc">ContextRefresher</span> <span class="n">contextRefresher</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">contextRefresher</span> <span class="o">=</span> <span class="n">contextRefresher</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@WriteOperation</span>
	<span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">refresh</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">contextRefresher</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">keys</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><p>ContextRefresher를 조금 더 들어가보겠습니다. 먼저 <code class="language-plaintext highlighter-rouge">refreshEnvironment()</code>는 빈을 refresh하지 않으며, config 설정만 refresh하고 이로 인해 변경된 config의 key값을 리턴합니다. <code class="language-plaintext highlighter-rouge">refresh()</code>의 경우 <code class="language-plaintext highlighter-rouge">refreshEnvironment()</code> 을 먼저 호출해서 config를 spring conetext에 저장하며 그 이후 <code class="language-plaintext highlighter-rouge">@RefreshScope</code> 빈을 모두 refresh하고 변경된 config의 key값을 리턴합니다.</p><p>이를 통해 bean overriding option에 따라 ConextRefresher의 구현체가 달라지는 것은 refresh할 때 빈을 정의하는 방식이 달라지기 때문임을 알 수 있습니다. 이는 <code class="language-plaintext highlighter-rouge">updateEnvironment()</code>를 구현체를 통해 구현한다는 것으로 이해할 수 있습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="c1">// package org.springframework.cloud.context.refresh.ContextRefresher;</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ContextRefresher</span> <span class="o">{</span>
  
	<span class="kd">private</span> <span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">;</span>
	<span class="kd">private</span> <span class="nc">RefreshScope</span> <span class="n">scope</span><span class="o">;</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">protected</span> <span class="nf">ContextRefresher</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">RefreshScope</span> <span class="n">scope</span><span class="o">,</span>
			<span class="nc">RefreshAutoConfiguration</span><span class="o">.</span><span class="na">RefreshProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">scope</span> <span class="o">=</span> <span class="n">scope</span><span class="o">;</span>
		<span class="n">additionalPropertySourcesToRetain</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="na">getAdditionalPropertySourcesToRetain</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">synchronized</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">refresh</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">refreshEnvironment</span><span class="o">();</span>
		<span class="k">this</span><span class="o">.</span><span class="na">scope</span><span class="o">.</span><span class="na">refreshAll</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">keys</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">synchronized</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">refreshEnvironment</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">before</span> <span class="o">=</span> <span class="n">extract</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">getEnvironment</span><span class="o">().</span><span class="na">getPropertySources</span><span class="o">());</span>
		<span class="n">updateEnvironment</span><span class="o">();</span>
		<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">changes</span><span class="o">(</span><span class="n">before</span><span class="o">,</span> <span class="n">extract</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">getEnvironment</span><span class="o">().</span><span class="na">getPropertySources</span><span class="o">())).</span><span class="na">keySet</span><span class="o">();</span>
		<span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">publishEvent</span><span class="o">(</span><span class="k">new</span> <span class="nc">EnvironmentChangeEvent</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">,</span> <span class="n">keys</span><span class="o">));</span>
		<span class="k">return</span> <span class="n">keys</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">updateEnvironment</span><span class="o">();</span>

	<span class="o">...</span>
<span class="o">}</span>
</pre></table></code></div></div><p>이를 통해 서비스 점검 시간 등 잘 변하지 않지만 종종 변경해줘야 값들 등 property에 넣어서 사용하는 값들을 배포 없이 config 서버의 값 변경만으로 준 실시간으로 적용할 수 있게됩니다. 또, 피쳐 플래그, 스프링 스케줄러, 외부 API 등 on/off 관련 기능에도 적용해볼 수 있습니다.</p><h3 id="주의사항"><span class="mr-2">주의사항</span><a href="#주의사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>시스템이 커지다 보면 코드량이 많아지면서 빌드 시간이 늘어나게 되고 스프링의 경우 어플리케이션 빈이 많아지다보면 실행 시간이 늘어나게됩니다. 이에 따라 설정값 변경만으로 인해 다시 배포하는데 시간이 오래 소요됩니다. 그래서 배포 없이 런타임 환경에서 설정 정보를 변경하는건 굉장히 유용하다고 생각합니다. 하지만 은탄환은 존재하지 않습니다.</p><p>먼저 <code class="language-plaintext highlighter-rouge">@RefreshScope</code>를 남용하면 안됩니다. datasource, redis, kafka와 같은 설정 정보들은 빈이 복잡하게 얽혀있고 서비스가 운영되는 중에 refresh를 하면 서버에 부담이 크게 작용할 수 있습니다. 실제로 사내에서 DataourceConfiguration 관련 빈에 RefreshScope을 넣어 서버가 죽은 경험도 있습니다. 차라리 해당 상황의 경우 배포를 다시해서 설정 정보를 초기화 하는게 더 안정적으로 서비스를 제공하는 방법이라고 생각합니다.</p><p>또, <code class="language-plaintext highlighter-rouge">ConetxtRefresher</code>를 활용할 때 ENC(value) 값과 같이 Jasypt를 이용해 암호화된 설정 값을 이용하게 되면 <code class="language-plaintext highlighter-rouge">refreshEnvironment()</code>에서 복호화된 값과 복호화되기 전의 값을 가져오게 되어 명확하게 변경된 설정값을 가져오지 못하는 현상도 존재합니다. 해당 이슈에 대해서는 다음 글에서 알아보도록 하겠습니다.</p><p>실제로 config 폴링에 대해 spring-cloud-commons docs에서는 <a href="https://docs.spring.io/spring-cloud-commons/docs/current/reference/html/#http-clients:~:text=Note%20that%20the%20Spring%20Cloud%20Config%20Client%20does%20not%2C%20by%20default%2C%20poll%20for%20changes%20in%20the%20Environment.%20Generally%2C%20we%20would%20not%20recommend%20that%20approach%20for%20detecting%20changes%20(although%20you%20can%20set%20it%20up%20with%20a%20%40Scheduled%20annotation)">폴링을 권장하지 않는 방법이라고</a> 언급합니다.</p><blockquote><p>Note that the Spring Cloud Config Client does not, by default, poll for changes in the <code class="language-plaintext highlighter-rouge">Environment</code>. Generally, we would not recommend that approach for detecting changes (although you can set it up with a <code class="language-plaintext highlighter-rouge">@Scheduled</code> annotation).</p></blockquote><p>폴링의 경우 Config Server에 대한 트래픽이 더 커지게 되고 조직의 규모가 커지고 해당 Config Server를 사용하는 API 서버들이 많아질수록 더 부하가 많이갈 수 있습니다. 이는 예상치 못한 일이 발생할 수 있기에 해당 방법을 차용하게되면 Config Server를 더 세심하게 모니터링해야 합니다. 현재 조직 상황에 맞는 방법을 적절히 사용하는게 가장 중요하다고 생각합니다. 실제로 <a href="https://www.youtube.com/watch?v=Zs3jVelp0L8&amp;t=1235s">Toss Slash 23 영상(20:35~)</a>에 따르면 운영 환경에서는 사용하지 않고 휴면 에러가 발생할 수 있다는 의견도 있기에 상황에 맞게 적절히 사용해야 합니다.</p><p>해당 소스 코드는 다음 <a href="https://github.com/ChoiEungi/spring-cloud-config-refresh">링크</a>에서 확인해볼 수 있습니다.</p><p>참고 링크</p><ul><li><a href="https://techblog.woowahan.com/7724/">https://techblog.woowahan.com/7724/</a><li><a href="https://www.youtube.com/watch?v=Zs3jVelp0L8&amp;t=1235s">https://www.youtube.com/watch?v=Zs3jVelp0L8&amp;t=1235s</a><li><a href="https://docs.spring.io/spring-cloud-commons/docs/current/reference/html/#http-clients:~:text=Note%20that%20the%20Spring%20Cloud%20Config%20Client%20does%20not%2C%20by%20default%2C%20poll%20for%20changes%20in%20the%20Environment.%20Generally%2C%20we%20would%20not%20recommend%20that%20approach%20for%20detecting%20changes%20(although%20you%20can%20set%20it%20up%20with%20a%20%40Scheduled%20annotation)">https://docs.spring.io/spring-cloud-commons/docs/current/reference/html/#http-clients:~:text=Note%20that%20the%20Spring%20Cloud%20Config%20Client%20does%20not%2C%20by%20default%2C%20poll%20for%20changes%20in%20the%20Environment.%20Generally%2C%20we%20would%20not%20recommend%20that%20approach%20for%20detecting%20changes%20(although%20you%20can%20set%20it%20up%20with%20a%20%40Scheduled%20annotation)</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/development/'>Development</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring-boot/" class="post-tag no-text-decoration" >Spring Boot</a> <a href="/tags/spring-cloud-config/" class="post-tag no-text-decoration" >Spring Cloud Config</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법 - Ruggy Blog&amp;url=https://choieungi.github.io/posts/spring-cloud-refresh/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법 - Ruggy Blog&amp;u=https://choieungi.github.io/posts/spring-cloud-refresh/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://choieungi.github.io/posts/spring-cloud-refresh/&amp;text=분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법 - Ruggy Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/spring-boot-cahce-error-handling/">Spring Boot에서 CacheManager를 에러 핸들링하는 방법</a><li><a href="/posts/spring-cloud-refresh/">분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법</a><li><a href="/posts/spring-redis-distributed-lock/">Spring MVC에서 redisson으로 분산락을 구현하는 방법들</a><li><a href="/posts/spring-redis-cache-serialization-exception/">Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점</a><li><a href="/posts/querydsl-connection-leak/">querydsl의 transform 메서드에서 발생하는 connection leak 현상</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spring-boot/">Spring Boot</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/thinking/">Thinking</a> <a class="post-tag" href="/tags/redis/">Redis</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/development/">Development</a> <a class="post-tag" href="/tags/gist-%EC%B2%AD%EC%9B%90/">GIST 청원</a> <a class="post-tag" href="/tags/git/">Git</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/spring/">Spring</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/gijol-%ED%9A%8C%EA%B3%A0/"><div class="card-body"> <em class="timeago small" data-ts="1653990180" > 2022-05-31 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Project] Gijol MVP 런칭 회고</h3><div class="text-muted small"><p> 배포 링크: Gijol BE 배경 GIST 청원 프로젝트를 진행하면서 크게 제품의 코드 작성법과 테스트, Operation, Git flow 등을 배울 수 있었다. 이를 청원팀의 팀원으로서 배웠던 점이 많은데 과연 이 배운 것들을 내가 스스로 해나갈 수 있을지에 대해서 의문이 들었다. 이에 대한 중요성과 필요성이 너무나도 중요하게 느껴졌기에...</p></div></div></a></div><div class="card"> <a href="/posts/spring-redis-cache-serialization-exception/"><div class="card-body"> <em class="timeago small" data-ts="1702218600" > 2023-12-10 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점</h3><div class="text-muted small"><p> 사내에서 패키지 구조 변경 작업을 하고 배포를 했는데 갑자기 특정 API에서 transaction silently rolled back이 발생했었습니다. 관련해서 확인해보니 DB조회 값을 Dto 객체로 변환해 캐싱한 값을 역직렬화하는 과정에서 문제가 발생했었습니다. 해당 캐시는 월마다 한번씩 바뀌는 주기를 갖는 값으로, 조회가 많은 비율을 차지합니다...</p></div></div></a></div><div class="card"> <a href="/posts/spring-redis-distributed-lock/"><div class="card-body"> <em class="timeago small" data-ts="1703427180" > 2023-12-24 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring MVC에서 redisson으로 분산락을 구현하는 방법들</h3><div class="text-muted small"><p> 멀티 인스턴스 환경에서 동시성을 해결하는 방법으로 Redis의 이벤트 루프 기반 싱글스레드 특성을 이용해 분산락을 사용해 쉽게 해결할 수 있습니다. 동시 호출은 DB 데이터의 정합이 깨지거나 메시지 이벤트의 중복 발행 등 예상치 못한 동작으로 이어지는 경우가 많아 해결해야 하는 경우가 빈번합니다. 분산락은 동시성을 제어하기 위한 부가 기능으로 비즈니...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/spring-redis-distributed-lock/" class="btn btn-outline-primary" prompt="Older"><p>Spring MVC에서 redisson으로 분산락을 구현하는 방법들</p></a> <a href="/posts/spring-boot-cahce-error-handling/" class="btn btn-outline-primary" prompt="Newer"><p>Spring Boot에서 CacheManager를 에러 핸들링하는 방법</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/Choieungi">Eungi, Choi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spring-boot/">Spring Boot</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/thinking/">Thinking</a> <a class="post-tag" href="/tags/redis/">Redis</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/development/">Development</a> <a class="post-tag" href="/tags/gist-%EC%B2%AD%EC%9B%90/">GIST 청원</a> <a class="post-tag" href="/tags/git/">Git</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/spring/">Spring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-3R6NSQ6EMQ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-3R6NSQ6EMQ'); }); </script>
