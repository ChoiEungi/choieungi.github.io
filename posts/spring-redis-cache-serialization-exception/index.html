<!DOCTYPE html><html lang="ko" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점" /><meta property="og:locale" content="ko" /><meta name="description" content="사내에서 패키지 구조 변경 작업을 하고 배포를 했는데 갑자기 특정 API에서 transaction silently rolled back이 발생했었습니다. 관련해서 확인해보니 DB조회 값을 Dto 객체로 변환해 캐싱한 값을 역직렬화하는 과정에서 문제가 발생했었습니다. 해당 캐시는 월마다 한번씩 바뀌는 주기를 갖는 값으로, 조회가 많은 비율을 차지합니다. 캐시로 사용하는 정보가 DB에서 열거형으로 관리되고 있어 이를 자바 Dto 객체로 직렬화해서 redis에 저장해 캐시로 활용하고 있었습니다." /><meta property="og:description" content="사내에서 패키지 구조 변경 작업을 하고 배포를 했는데 갑자기 특정 API에서 transaction silently rolled back이 발생했었습니다. 관련해서 확인해보니 DB조회 값을 Dto 객체로 변환해 캐싱한 값을 역직렬화하는 과정에서 문제가 발생했었습니다. 해당 캐시는 월마다 한번씩 바뀌는 주기를 갖는 값으로, 조회가 많은 비율을 차지합니다. 캐시로 사용하는 정보가 DB에서 열거형으로 관리되고 있어 이를 자바 Dto 객체로 직렬화해서 redis에 저장해 캐시로 활용하고 있었습니다." /><link rel="canonical" href="https://choieungi.github.io/posts/spring-redis-cache-serialization-exception/" /><meta property="og:url" content="https://choieungi.github.io/posts/spring-redis-cache-serialization-exception/" /><meta property="og:site_name" content="Ruggy Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-12-10T23:30:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-12-24T23:09:02+09:00","datePublished":"2023-12-10T23:30:00+09:00","description":"사내에서 패키지 구조 변경 작업을 하고 배포를 했는데 갑자기 특정 API에서 transaction silently rolled back이 발생했었습니다. 관련해서 확인해보니 DB조회 값을 Dto 객체로 변환해 캐싱한 값을 역직렬화하는 과정에서 문제가 발생했었습니다. 해당 캐시는 월마다 한번씩 바뀌는 주기를 갖는 값으로, 조회가 많은 비율을 차지합니다. 캐시로 사용하는 정보가 DB에서 열거형으로 관리되고 있어 이를 자바 Dto 객체로 직렬화해서 redis에 저장해 캐시로 활용하고 있었습니다.","headline":"Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점","mainEntityOfPage":{"@type":"WebPage","@id":"https://choieungi.github.io/posts/spring-redis-cache-serialization-exception/"},"url":"https://choieungi.github.io/posts/spring-redis-cache-serialization-exception/"}</script><title>Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점 | Ruggy Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ruggy Blog"><meta name="application-name" content="Ruggy Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://avatars.githubusercontent.com/u/70755947?v=4 " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ruggy Blog</a></div><div class="site-subtitle font-italic">Growth Process as Developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/choieungi" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/eungi-choi-a8565620b" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['choieungi','gm.gist.ac.kr'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/Choieungi">Eungi, Choi</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1702218600" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-12-10 </em> </span> <span> Updated <em class="timeago" data-ts="1703426942" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-12-24 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1167 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><p>사내에서 패키지 구조 변경 작업을 하고 배포를 했는데 갑자기 특정 API에서 <code class="language-plaintext highlighter-rouge">transaction silently rolled back</code>이 발생했었습니다. 관련해서 확인해보니 DB조회 값을 Dto 객체로 변환해 캐싱한 값을 역직렬화하는 과정에서 문제가 발생했었습니다. 해당 캐시는 월마다 한번씩 바뀌는 주기를 갖는 값으로, 조회가 많은 비율을 차지합니다. 캐시로 사용하는 정보가 DB에서 열거형으로 관리되고 있어 이를 자바 Dto 객체로 직렬화해서 redis에 저장해 캐시로 활용하고 있었습니다.</p><p>코드를 확인해보면 다음과 같습니다.</p><h3 id="문제-상황"><span class="mr-2">문제 상황</span><a href="#문제-상황" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>설정 값들</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="c1">// package com.example.redisinactions.api;</span>
<span class="nd">@Getter</span>  
<span class="nd">@AllArgsConstructor</span><span class="o">(</span><span class="n">access</span> <span class="o">=</span> <span class="nc">AccessLevel</span><span class="o">.</span><span class="na">PRIVATE</span><span class="o">)</span>  
<span class="nd">@NoArgsConstructor</span><span class="o">(</span><span class="n">access</span> <span class="o">=</span> <span class="nc">AccessLevel</span><span class="o">.</span><span class="na">PROTECTED</span><span class="o">)</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductResponse</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>  
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">description</span><span class="o">;</span>  
	<span class="kd">private</span> <span class="nc">BigDecimal</span> <span class="n">price</span><span class="o">;</span>  
  
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">ProductResponse</span> <span class="nf">of</span><span class="o">(</span><span class="nc">Product</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>  
		<span class="k">return</span> <span class="k">new</span> <span class="nf">ProductResponse</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(),</span> <span class="n">product</span><span class="o">.</span><span class="na">getPrice</span><span class="o">());</span>  
	<span class="o">}</span>  
  
	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ProductResponse</span><span class="o">&gt;</span> <span class="nf">listOf</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">productList</span><span class="o">)</span> <span class="o">{</span>  
		<span class="k">return</span> <span class="n">productList</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>  
		<span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">ProductResponse:</span><span class="o">:</span><span class="n">of</span><span class="o">)</span>  
		<span class="o">.</span><span class="na">toList</span><span class="o">();</span>  
	<span class="o">}</span>  
<span class="o">}</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableCaching</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CacheConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">RedisCacheConfiguration</span> <span class="nf">cacheConfiguration</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">RedisCacheConfiguration</span><span class="o">.</span><span class="na">defaultCacheConfig</span><span class="o">()</span>
                <span class="o">.</span><span class="na">entryTtl</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofMinutes</span><span class="o">(</span><span class="mi">60</span><span class="o">))</span>
                <span class="o">.</span><span class="na">disableCachingNullValues</span><span class="o">()</span>
                <span class="o">.</span><span class="na">serializeKeysWith</span><span class="o">(</span><span class="nc">SerializationPair</span><span class="o">.</span><span class="na">fromSerializer</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringRedisSerializer</span><span class="o">()))</span>
                <span class="o">.</span><span class="na">serializeValuesWith</span><span class="o">(</span><span class="nc">SerializationPair</span><span class="o">.</span><span class="na">fromSerializer</span><span class="o">(</span><span class="k">new</span> <span class="nc">GenericJackson2JsonRedisSerializer</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">RedisCacheManagerBuilderCustomizer</span> <span class="nf">redisCacheManagerBuilderCustomizer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">builder</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">builder</span>
                <span class="o">.</span><span class="na">withCacheConfiguration</span><span class="o">(</span><span class="no">PRODUCT_CACHE</span><span class="o">,</span>
                        <span class="nc">RedisCacheConfiguration</span><span class="o">.</span><span class="na">defaultCacheConfig</span><span class="o">().</span><span class="na">entryTtl</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofMinutes</span><span class="o">(</span><span class="mi">10</span><span class="o">)));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CacheName</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PRODUCT_CACHE</span> <span class="o">=</span> <span class="s">"productCache"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></table></code></div></div><p>레디스 캐시를 사용하는 서비스</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ProductRepository</span> <span class="n">productRepository</span><span class="o">;</span>

    <span class="nd">@PostConstruct</span>
    <span class="kt">void</span> <span class="nf">initProducts</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">productRepository</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
                        <span class="k">new</span> <span class="nf">Product</span><span class="o">(</span><span class="s">"box"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="mi">1000</span><span class="o">)),</span>
                        <span class="k">new</span> <span class="nf">Product</span><span class="o">(</span><span class="s">"snack"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="mi">4000</span><span class="o">)),</span>
                        <span class="k">new</span> <span class="nf">Product</span><span class="o">(</span><span class="s">"chicken"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="mi">20000</span><span class="o">))</span>
                <span class="o">)</span>
        <span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">cacheNames</span> <span class="o">=</span> <span class="no">PRODUCT_CACHE</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"'top10'"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ProductResponse</span><span class="o">&gt;</span> <span class="nf">getTenProduct</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"NO CACHE - find top 10 products from DB"</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">ProductResponse</span><span class="o">.</span><span class="na">listOf</span><span class="o">(</span><span class="n">productRepository</span><span class="o">.</span><span class="na">findTop10By</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@CacheEvict</span><span class="o">(</span><span class="n">cacheNames</span> <span class="o">=</span> <span class="no">PRODUCT_CACHE</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"'top10'"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">evict</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Cache Evicted"</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api/v1"</span><span class="o">)</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ProductService</span> <span class="n">productService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/products/top10"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;?&gt;</span> <span class="n">getTop10Products</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="n">productService</span><span class="o">.</span><span class="na">getTenProduct</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>해당 코드에서 getTenProduct()를 먼저 호출하면 다음과 같은 응답이 오며 redis에 잘 쌓이게 됩니다.</p><p><img data-src="https://i.imgur.com/yGBPAuN.png" alt="" data-proofer-ignore></p><p><img data-src="https://i.imgur.com/s6JUDmM.png" alt="" data-proofer-ignore></p><p>해당 상황을 도식화 하면 다음과 같습니다.</p><p><img data-src="https://i.imgur.com/YAYsWIq.png" alt="" data-proofer-ignore></p><p>이후 ProductResponse를 v2 패키지로 변경한 이후 어플리케이션을 재실행해서 동일한 API를 호출하면 SerializationException이 발생합니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// package com.example.redisinactions.api.v2;</span>
<span class="nd">@Getter</span>  
<span class="nd">@AllArgsConstructor</span><span class="o">(</span><span class="n">access</span> <span class="o">=</span> <span class="nc">AccessLevel</span><span class="o">.</span><span class="na">PRIVATE</span><span class="o">)</span>  
<span class="nd">@NoArgsConstructor</span><span class="o">(</span><span class="n">access</span> <span class="o">=</span> <span class="nc">AccessLevel</span><span class="o">.</span><span class="na">PROTECTED</span><span class="o">)</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductResponse</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
   <span class="o">...</span>
<span class="o">}</span>
</pre></table></code></div></div><p><img data-src="https://i.imgur.com/KlKjpgm.png" alt="" data-proofer-ignore></p><p>Exception의 cause를 확인해보면 <code class="language-plaintext highlighter-rouge">ClassNotFountException</code>이 발생합니다. <code class="language-plaintext highlighter-rouge">com.example.redisinactions.api.ProductResponse</code> 클래스를 역직렬화해야 하는데 해당 클래스가 <code class="language-plaintext highlighter-rouge">com.example.redisinactions.api.v2.ProductResponse</code>로 변경되어 발생한 현상입니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nc">Caused</span> <span class="nl">by:</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ClassNotFoundException</span><span class="o">:</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">redisinactions</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">ProductResponse</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">base</span><span class="o">/</span><span class="n">jdk</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">loader</span><span class="o">.</span><span class="na">BuiltinClassLoader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="nc">BuiltinClassLoader</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">641</span><span class="o">)</span> <span class="o">~[</span><span class="nl">na:</span><span class="n">na</span><span class="o">]</span>
	<span class="o">...</span>
</pre></table></code></div></div><p><img data-src="https://i.imgur.com/whlF2nJ.png" alt="" data-proofer-ignore></p><h3 id="해결-방법-cache-key-prefix-변경"><span class="mr-2">해결 방법: Cache Key Prefix 변경</span><a href="#해결-방법-cache-key-prefix-변경" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>해당 문제를 해결하기 위해서 <code class="language-plaintext highlighter-rouge">@Cacheable</code>에서 키값 deserialization에서 오류가 나는 것이므로 키값을 바꿔줘서 해결할 수 있습니다. 기존에 저장된 캐시를 재사용하는 부분에서 문제가 발생하는 것이기에 새로운 캐시를 다시 저장하고 이를 활용하면 됩니다. 기존 키값에 해당하는 값은 역직렬화할 수 없으므로 자연스럽게 TTL로 인해 사라지게 됩니다. 이를 통해 서비스에 지장 없이 안정적으로 캐시를 변경해서 사용할 수 있습니다. 코드로 나타나면 다음과 같습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@EnableCaching</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CacheConfig</span> <span class="o">{</span>
   <span class="o">...</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CacheName</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PRODUCT_CACHE</span> <span class="o">=</span> <span class="s">"V2_productCache"</span><span class="o">;</span> <span class="c1">// as-is: productCache</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><img data-src="https://i.imgur.com/tm5aDLE.png" alt="" data-proofer-ignore></p><p>사실 해당 값을 캐싱하는 부분에서 꼭 Redis를 이용해야 하는 부분에 대해서도 고민해볼 필요가 있습니다. Redis가 아니더라도 LocalCache를 이용한다면 빈을 주입할 때 값을 DB에서 조회해서 캐싱해서 사용하는 방법도 좋은 방법이라고 생각합니다.</p><p>본래 문제는 이로 인한 트랜잭션의 실패였습니다. 더 생각해볼 점은 <code class="language-plaintext highlighter-rouge">@Cacheable</code>은 <a href="https://yearnlune.github.io/general/cache-aside-pattern/#">Cahce aside pattern</a>을 사용하는데 해당 전략은 캐시 조회가 실패한다면 원본 데이터에서 가져오는 전략입니다. 따라서 해당 작업이 트랜잭션에서 캐시 조회에서 오류가 발생한다고 롤백 마크로 인해 전체 트랜잭션이 실패하면 안된다고 생각합니다. 이는 트랜잭션을 사용할 때 두고두고 고민해야 하는 부분이라고 생각합니다.</p><p>관련 소스 코드는 다음 <a href="https://github.com/ChoiEungi/redis-in-actions/tree/feature/redis-cacheable">링크</a>에서 확인할 수 있습니다.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/development/'>Development</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring-boot/" class="post-tag no-text-decoration" >Spring Boot</a> <a href="/tags/redis/" class="post-tag no-text-decoration" >Redis</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점 - Ruggy Blog&amp;url=https://choieungi.github.io/posts/spring-redis-cache-serialization-exception/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점 - Ruggy Blog&amp;u=https://choieungi.github.io/posts/spring-redis-cache-serialization-exception/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://choieungi.github.io/posts/spring-redis-cache-serialization-exception/&amp;text=Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점 - Ruggy Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/spring-boot-cahce-error-handling/">Spring Boot에서 CacheManager를 에러 핸들링하는 방법</a><li><a href="/posts/spring-cloud-refresh/">분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법</a><li><a href="/posts/spring-redis-distributed-lock/">Spring MVC에서 redisson으로 분산락을 구현하는 방법들</a><li><a href="/posts/spring-redis-cache-serialization-exception/">Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점</a><li><a href="/posts/querydsl-connection-leak/">querydsl의 transform 메서드에서 발생하는 connection leak 현상</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spring-boot/">Spring Boot</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/thinking/">Thinking</a> <a class="post-tag" href="/tags/redis/">Redis</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/development/">Development</a> <a class="post-tag" href="/tags/gist-%EC%B2%AD%EC%9B%90/">GIST 청원</a> <a class="post-tag" href="/tags/git/">Git</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/spring/">Spring</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/spring-redis-distributed-lock/"><div class="card-body"> <em class="timeago small" data-ts="1703427180" > 2023-12-24 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring MVC에서 redisson으로 분산락을 구현하는 방법들</h3><div class="text-muted small"><p> 멀티 인스턴스 환경에서 동시성을 해결하는 방법으로 Redis의 이벤트 루프 기반 싱글스레드 특성을 이용해 분산락을 사용해 쉽게 해결할 수 있습니다. 동시 호출은 DB 데이터의 정합이 깨지거나 메시지 이벤트의 중복 발행 등 예상치 못한 동작으로 이어지는 경우가 많아 해결해야 하는 경우가 빈번합니다. 분산락은 동시성을 제어하기 위한 부가 기능으로 비즈니...</p></div></div></a></div><div class="card"> <a href="/posts/spring-boot-cahce-error-handling/"><div class="card-body"> <em class="timeago small" data-ts="1711851720" > 2024-03-31 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Boot에서 CacheManager를 에러 핸들링하는 방법</h3><div class="text-muted small"><p> 본 글은 아래 링크의 글의 내용과 이어집니다. https://choieungi.github.io/posts/spring-redis-cache-serialization-exception Spring에서 제공하는 @Cacheable을 이용하면 캐쉬를 AOP 기반으로 쉽게 사용할 수 있습니다. 이전 글에서 다뤘듯, 기본적으로 @Cacheable ...</p></div></div></a></div><div class="card"> <a href="/posts/gijol-%ED%9A%8C%EA%B3%A0/"><div class="card-body"> <em class="timeago small" data-ts="1653990180" > 2022-05-31 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Project] Gijol MVP 런칭 회고</h3><div class="text-muted small"><p> 배포 링크: Gijol BE 배경 GIST 청원 프로젝트를 진행하면서 크게 제품의 코드 작성법과 테스트, Operation, Git flow 등을 배울 수 있었다. 이를 청원팀의 팀원으로서 배웠던 점이 많은데 과연 이 배운 것들을 내가 스스로 해나갈 수 있을지에 대해서 의문이 들었다. 이에 대한 중요성과 필요성이 너무나도 중요하게 느껴졌기에...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/mysql-resources/" class="btn btn-outline-primary" prompt="Older"><p>MySQL 커넥션, I/O 연산, 잠금에 대한 고찰</p></a> <a href="/posts/spring-redis-distributed-lock/" class="btn btn-outline-primary" prompt="Newer"><p>Spring MVC에서 redisson으로 분산락을 구현하는 방법들</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/Choieungi">Eungi, Choi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spring-boot/">Spring Boot</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/thinking/">Thinking</a> <a class="post-tag" href="/tags/redis/">Redis</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/development/">Development</a> <a class="post-tag" href="/tags/gist-%EC%B2%AD%EC%9B%90/">GIST 청원</a> <a class="post-tag" href="/tags/git/">Git</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/spring/">Spring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-3R6NSQ6EMQ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-3R6NSQ6EMQ'); }); </script>
