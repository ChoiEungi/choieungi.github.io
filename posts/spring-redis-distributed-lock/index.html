<!DOCTYPE html><html lang="ko" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Spring MVC에서 redisson으로 분산락을 구현하는 방법들" /><meta property="og:locale" content="ko" /><meta name="description" content="멀티 인스턴스 환경에서 동시성을 해결하는 방법으로 Redis의 이벤트 루프 기반 싱글스레드 특성을 이용해 분산락을 사용해 쉽게 해결할 수 있습니다. 동시 호출은 DB 데이터의 정합이 깨지거나 메시지 이벤트의 중복 발행 등 예상치 못한 동작으로 이어지는 경우가 많아 해결해야 하는 경우가 빈번합니다." /><meta property="og:description" content="멀티 인스턴스 환경에서 동시성을 해결하는 방법으로 Redis의 이벤트 루프 기반 싱글스레드 특성을 이용해 분산락을 사용해 쉽게 해결할 수 있습니다. 동시 호출은 DB 데이터의 정합이 깨지거나 메시지 이벤트의 중복 발행 등 예상치 못한 동작으로 이어지는 경우가 많아 해결해야 하는 경우가 빈번합니다." /><link rel="canonical" href="https://choieungi.github.io/posts/spring-redis-distributed-lock/" /><meta property="og:url" content="https://choieungi.github.io/posts/spring-redis-distributed-lock/" /><meta property="og:site_name" content="Ruggy Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-12-24T23:13:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Spring MVC에서 redisson으로 분산락을 구현하는 방법들" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-12-24T23:45:14+09:00","datePublished":"2023-12-24T23:13:00+09:00","description":"멀티 인스턴스 환경에서 동시성을 해결하는 방법으로 Redis의 이벤트 루프 기반 싱글스레드 특성을 이용해 분산락을 사용해 쉽게 해결할 수 있습니다. 동시 호출은 DB 데이터의 정합이 깨지거나 메시지 이벤트의 중복 발행 등 예상치 못한 동작으로 이어지는 경우가 많아 해결해야 하는 경우가 빈번합니다.","headline":"Spring MVC에서 redisson으로 분산락을 구현하는 방법들","mainEntityOfPage":{"@type":"WebPage","@id":"https://choieungi.github.io/posts/spring-redis-distributed-lock/"},"url":"https://choieungi.github.io/posts/spring-redis-distributed-lock/"}</script><title>Spring MVC에서 redisson으로 분산락을 구현하는 방법들 | Ruggy Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ruggy Blog"><meta name="application-name" content="Ruggy Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://avatars.githubusercontent.com/u/70755947?v=4 " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ruggy Blog</a></div><div class="site-subtitle font-italic">Growth Process as Developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/choieungi" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/eungi-choi-a8565620b" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['choieungi','gm.gist.ac.kr'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Spring MVC에서 redisson으로 분산락을 구현하는 방법들</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Spring MVC에서 redisson으로 분산락을 구현하는 방법들</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/Choieungi">Eungi, Choi</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1703427180" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-12-24 </em> </span> <span> Updated <em class="timeago" data-ts="1703429114" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-12-24 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3159 words"> <em>17 min</em> read</span></div></div></div><div class="post-content"><p>멀티 인스턴스 환경에서 동시성을 해결하는 방법으로 Redis의 이벤트 루프 기반 싱글스레드 특성을 이용해 분산락을 사용해 쉽게 해결할 수 있습니다. 동시 호출은 DB 데이터의 정합이 깨지거나 메시지 이벤트의 중복 발행 등 예상치 못한 동작으로 이어지는 경우가 많아 해결해야 하는 경우가 빈번합니다.</p><p>분산락은 동시성을 제어하기 위한 부가 기능으로 비즈니스 로직과 섞이지 않도록 관심사를 잘 분리하는게 좋습니다. 관련해서 스프링은 Dependency Injection, AOP와 같은 여러 기능을 쉽게 사용할 수 있어 여러 구현 방법을 소개해보려 합니다. 구현은 Java, Spring MVC 기반으로 Redisson을 이용해 구현할 예정입니다.</p><h3 id="요구사항"><span class="mr-2">요구사항</span><a href="#요구사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>분산락이 실패하는 경우 null을 리턴하게 됩니다.<li>레디스 장애가 발생해도 원래 메소드는 동작해야 합니다.<li>락 내부 트랜잭션을 사용할 수 있어야 하며 락이 끝나기 전에 트랜잭션이 종료되어야 합니다. 트랜잭션이 종료되어야 하는 이유는 트랜잭션이 종료함으로 DB에 저장된 시점에 락을 해제해야 동시 호출에 대한 온전히 제어할 수 있기 때문입니다. 더 자세한 내용은 <a href="https://helloworld.kurly.com/blog/distributed-redisson-lock/#3-%EB%B6%84%EC%82%B0%EB%9D%BD%EC%9D%84-%EB%B3%B4%EB%8B%A4-%EC%86%90%EC%89%BD%EA%B2%8C-%EC%82%AC%EC%9A%A9%ED%95%A0-%EC%88%98%EB%8A%94-%EC%97%86%EC%9D%84%EA%B9%8C">다음 글</a>에서 소개하고 있기에 본 글에서는 생략하겠습니다.<li>락 설정 정보를 하나의 enum으로 관리할 수 있어야 합니다.</ul><h3 id="함수형-인터페이스를-이용한-구현-template-callback-패턴"><span class="mr-2">함수형 인터페이스를 이용한 구현 (template callback 패턴)</span><a href="#함수형-인터페이스를-이용한-구현-template-callback-패턴" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>락을 잡으려고 하는 구간을 함수형 인터페이스(콜백 함수) 인자로 받아서 처리하는 방법입니다. 트랜잭션을 사용할 수 있으며, 트랜잭션의 종료를 보장하기 위해 전파 옵션을 <code class="language-plaintext highlighter-rouge">PROPAGATION_REQUIRES_NEW</code>로 설정했습니다. 구현 코드 다음과 같습니다.</p><p><strong>Lock 설정(enum) 코드</strong></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">enum</span> <span class="nc">LockConfig</span> <span class="o">{</span>

  <span class="no">PRODUCT_DECREASE</span><span class="o">(</span><span class="s">"PRODUCT"</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">),</span>
  <span class="no">LOGIN_LOCK</span><span class="o">(</span><span class="s">"LOGIN_LOCK"</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>

  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Long</span> <span class="n">waitTime</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Long</span> <span class="n">leaseTime</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">TimeUnit</span> <span class="n">timeUnit</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">lockPrefix</span><span class="o">;</span>

  <span class="nc">LockConfig</span><span class="o">(</span><span class="nc">String</span> <span class="n">lockPrefix</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">waitTime</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">leaseTime</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">timeUnit</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">lockPrefix</span> <span class="o">=</span> <span class="n">lockPrefix</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">waitTime</span> <span class="o">=</span> <span class="n">waitTime</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">leaseTime</span> <span class="o">=</span> <span class="n">leaseTime</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">timeUnit</span> <span class="o">=</span> <span class="n">timeUnit</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">generateKey</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"key must not be empty"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s_%s"</span><span class="o">,</span> <span class="n">lockPrefix</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre><td class="rouge-code"><pre><span class="nd">@Component</span>  
<span class="nd">@Slf4j</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedissonDistributedLockTemplate</span> <span class="o">{</span>  
  
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RedissonClient</span> <span class="n">redissonClient</span><span class="o">;</span>  
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TransactionTemplate</span> <span class="n">transactionTemplate</span><span class="o">;</span>  
  
  <span class="kd">public</span> <span class="nf">RedissonDistributedLockTemplate</span><span class="o">(</span><span class="nc">RedissonClient</span> <span class="n">redissonClient</span><span class="o">,</span> <span class="nc">PlatformTransactionManager</span> <span class="n">platformTransactionManager</span><span class="o">)</span> <span class="o">{</span>  
    <span class="k">this</span><span class="o">.</span><span class="na">redissonClient</span> <span class="o">=</span> <span class="n">redissonClient</span><span class="o">;</span>  
    <span class="k">this</span><span class="o">.</span><span class="na">transactionTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TransactionTemplate</span><span class="o">(</span><span class="n">platformTransactionManager</span><span class="o">);</span>  
    <span class="k">this</span><span class="o">.</span><span class="na">transactionTemplate</span><span class="o">.</span><span class="na">setPropagationBehavior</span><span class="o">(</span><span class="nc">TransactionDefinition</span><span class="o">.</span><span class="na">PROPAGATION_REQUIRES_NEW</span><span class="o">);</span>  
    <span class="k">this</span><span class="o">.</span><span class="na">transactionTemplate</span><span class="o">.</span><span class="na">afterPropertiesSet</span><span class="o">();</span>  
  <span class="o">}</span>  
  
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">executeWithLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">LockConfig</span> <span class="n">lockConfig</span><span class="o">,</span> <span class="nc">Runnable</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>  
    <span class="n">executeWithLock</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">lockConfig</span><span class="o">,</span> <span class="n">toVoidSupplier</span><span class="o">(</span><span class="n">callback</span><span class="o">));</span>  
  <span class="o">}</span>  
  
  <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">executeWithLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">LockConfig</span> <span class="n">lockConfig</span><span class="o">,</span> <span class="nc">Supplier</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>  
    <span class="nc">RLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">redissonClient</span><span class="o">.</span><span class="na">getLock</span><span class="o">(</span><span class="n">lockConfig</span><span class="o">.</span><span class="na">generateKey</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>  
  
    <span class="k">try</span> <span class="o">{</span>  
      <span class="kt">boolean</span> <span class="n">isAcquired</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">lockConfig</span><span class="o">.</span><span class="na">waitTime</span><span class="o">,</span> <span class="n">lockConfig</span><span class="o">.</span><span class="na">leaseTime</span><span class="o">,</span> <span class="n">lockConfig</span><span class="o">.</span><span class="na">timeUnit</span><span class="o">);</span>  
      <span class="k">if</span> <span class="o">(!</span><span class="n">isAcquired</span><span class="o">)</span> <span class="o">{</span>  
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"[lock 획득 실패] {}, key : {}"</span><span class="o">,</span> <span class="n">lockConfig</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>  
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>      <span class="o">}</span>  
      <span class="k">return</span> <span class="n">callback</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>  
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RedisConnectionException</span> <span class="n">redisUnavailableException</span><span class="o">)</span> <span class="o">{</span>  
      <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="n">redisUnavailableException</span><span class="o">);</span>  
      <span class="k">return</span> <span class="n">callback</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>  
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>  
      <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>  
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>  
      <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">isLocked</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">lock</span><span class="o">.</span><span class="na">isHeldByCurrentThread</span><span class="o">())</span> <span class="o">{</span>  
        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>  
      <span class="o">}</span>  
    <span class="o">}</span>  
  <span class="o">}</span>  
  
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">executeWithLockAndTransaction</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">LockConfig</span> <span class="n">lockConfig</span><span class="o">,</span> <span class="nc">Runnable</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>  
    <span class="n">executeWithLockAndTransaction</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">lockConfig</span><span class="o">,</span> <span class="n">toVoidSupplier</span><span class="o">(</span><span class="n">callback</span><span class="o">));</span>  
  <span class="o">}</span>  
  
  <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">executeWithLockAndTransaction</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">LockConfig</span> <span class="n">lockConfig</span><span class="o">,</span> <span class="nc">Supplier</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>  
    <span class="nc">RLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">redissonClient</span><span class="o">.</span><span class="na">getLock</span><span class="o">(</span><span class="n">lockConfig</span><span class="o">.</span><span class="na">generateKey</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>  
  
    <span class="k">try</span> <span class="o">{</span>  
      <span class="kt">boolean</span> <span class="n">isAcquired</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">lockConfig</span><span class="o">.</span><span class="na">waitTime</span><span class="o">,</span> <span class="n">lockConfig</span><span class="o">.</span><span class="na">leaseTime</span><span class="o">,</span> <span class="n">lockConfig</span><span class="o">.</span><span class="na">timeUnit</span><span class="o">);</span>  
      <span class="k">if</span> <span class="o">(!</span><span class="n">isAcquired</span><span class="o">)</span> <span class="o">{</span>  
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"[lock 획득 실패] {}, key : {}"</span><span class="o">,</span> <span class="n">lockConfig</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>  
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>      <span class="o">}</span>  
      <span class="k">return</span> <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">status</span> <span class="o">-&gt;</span> <span class="n">callback</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>  
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RedisConnectionException</span> <span class="n">redisUnavailableException</span><span class="o">)</span> <span class="o">{</span>  
      <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="n">redisUnavailableException</span><span class="o">);</span>  
      <span class="k">return</span> <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">status</span> <span class="o">-&gt;</span> <span class="n">callback</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>  
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>  
      <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>  
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>  
      <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">isLocked</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">lock</span><span class="o">.</span><span class="na">isHeldByCurrentThread</span><span class="o">())</span> <span class="o">{</span>  
        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>  
      <span class="o">}</span>  
    <span class="o">}</span>  
  <span class="o">}</span>  
  
  <span class="kd">private</span> <span class="nc">Supplier</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">toVoidSupplier</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">runnable</span><span class="o">)</span> <span class="o">{</span>  
    <span class="k">return</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>  
      <span class="n">runnable</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>  
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>    <span class="o">};</span>  
  <span class="o">}</span>  
  
<span class="o">}</span>

</pre></table></code></div></div><ul><li>waitTime의 경우 락을 획득하는데 기다리는 시간입니다. waitTime이 지나면 락 획득에 실패하며 tryLock의 리턴값은 false가 됩니다.<li>leaseTime은 락을 획득한 이후에 락을 잡고있는 시간을 의미합니다. 락을 획득하고 leaseTime보다 더 오래 작업이 걸리면 작업이 종료된 유무와 관계없이 락을 해제하게 됩니다. 이후 동일키로 다른 락 획득 요청이 있는 경우 성공적으로 획득하게 됩니다. 일반적으로 leaseTime으로 인해 락이 해제되기 전에 작업이 종료되어야 하기 때문에 leaseTime을 작업의 최대 시간으로 설정하는게 좋습니다.<li>redis의 상태에 이상이 생기고 작업을 요청하게되면<code class="language-plaintext highlighter-rouge">RedisConnectionException</code>이 발생하게 됩니다. 레디스가 문제가 생겼을 때에도 본 메소드에는 영향이 없어야 하는 상황이 요구사항이기에 해당 상황에서 메소드를 정상적으로 실행합니다. 이 경우 동시 요청이 다시 발생할 수 있게됩니다. 해당 상황에서 동시 요청 처리가 비즈니스에 중요하다면 해당 상황에서 실패처리 하는 것도 방법입니다. 따라서 상황에 맞게 효용가치가 큰 방법을 취사하는게 중요합니다.<li>트랜잭션의 경우 선언형으로 사용하기 어려워 <code class="language-plaintext highlighter-rouge">TransactionTemplate</code>을 이용해 구현했습니다. Mvc에서 일반적으로 트랜잭션을 관리하는데 사용하는 <code class="language-plaintext highlighter-rouge">PlatformTransactionManager</code>을 주입받아 사용하였습니다.</ul><p>사용하는 코드는 다음과 같습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>
<span class="nd">@Service</span>  
<span class="nd">@RequiredArgsConstructor</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">V2ProductService</span> <span class="o">{</span>  
  
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ProductRepository</span> <span class="n">productRepository</span><span class="o">;</span>  
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RedissonDistributedLockTemplate</span> <span class="n">redissonDistributedLockTemplate</span><span class="o">;</span>  
  
  <span class="o">...</span> 
  
  <span class="kd">public</span> <span class="nc">Product</span> <span class="nf">decreaseWithCallback</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">quantity</span><span class="o">)</span> <span class="o">{</span>  
    <span class="nc">Product</span> <span class="n">result</span> <span class="o">=</span> <span class="n">redissonDistributedLockTemplate</span><span class="o">.</span><span class="na">executeWithLock</span><span class="o">(</span><span class="n">id</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="no">PRODUCT_DECREASE</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>  
      <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">productRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">();</span>  
      <span class="n">product</span><span class="o">.</span><span class="na">decrease</span><span class="o">(</span><span class="n">quantity</span><span class="o">);</span>  
      <span class="k">return</span> <span class="n">productRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>  
    <span class="o">});</span>  
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>  
  <span class="o">}</span>  
  
  <span class="kd">public</span> <span class="nc">Product</span> <span class="nf">decreaseWithCallbackTransaction</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">quantity</span><span class="o">)</span> <span class="o">{</span>  
    <span class="nc">Product</span> <span class="n">result</span> <span class="o">=</span> <span class="n">redissonDistributedLockTemplate</span><span class="o">.</span><span class="na">executeWithLockAndTransaction</span><span class="o">(</span><span class="n">id</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="no">PRODUCT_DECREASE</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>  
      <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">productRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">();</span>  
      <span class="n">product</span><span class="o">.</span><span class="na">decrease</span><span class="o">(</span><span class="n">quantity</span><span class="o">);</span>  
      <span class="k">return</span> <span class="n">product</span><span class="o">;</span>  
    <span class="o">});</span>  
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>  
  <span class="o">}</span>  
  
<span class="o">}</span>

</pre></table></code></div></div><p>테스트 코드</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="nd">@SpringBootTest</span>
<span class="kd">class</span> <span class="nc">V2ProductServiceTest</span> <span class="o">{</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">V2ProductService</span> <span class="n">v2ProductService</span><span class="o">;</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">ProductRepository</span> <span class="n">productRepository</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nc">Product</span> <span class="n">product</span><span class="o">;</span>

  <span class="nd">@BeforeEach</span>
  <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">productRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"description"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="mi">10000</span><span class="o">),</span> <span class="mi">100L</span><span class="o">));</span>
  <span class="o">}</span>
  
  <span class="o">...</span>

  <span class="nd">@Test</span>
  <span class="kt">void</span> <span class="nf">decreaseWithCallback</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// given</span>
    <span class="kt">int</span> <span class="n">requestCount</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">CompletableFuture</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">futureList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">requestCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">objectCompletableFuture</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">v2ProductService</span><span class="o">.</span><span class="na">decreaseWithCallback</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="mi">1L</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">});</span>
      <span class="n">futureList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">objectCompletableFuture</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// then</span>
    <span class="nc">Product</span> <span class="n">result</span> <span class="o">=</span> <span class="n">productRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">orElseThrow</span><span class="o">();</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getQuantity</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">90L</span><span class="o">);</span>

  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>장점</p><ul><li>특별한 클래스 분리가 필요 없이 Template 주입만을 통해서 메소드 내부에서 직접 락 구간을 지정할 수 있습니다.</ul><p>단점</p><ul><li>기존 코드의 depth가 깊거나 콜백(함수형 인터페이스)을 사용하는 코드가 많다면, 콜백 지옥에 빠질 수 있습니다.<li>콜백 메소드 내부에서 값들이 여러개라면 해당 값들을 모두 리턴해야 합니다. 그렇게 되면 이를 위한 객체를 만들어야 합니다.<li>부가 기능이 테스트에 영향을 주게 됩니다. 콜백 메소드 내부만 테스트하고 싶다면 template에 대한 Mocking혹은 Stubbing 필요합니다.</ul><h3 id="aopaspect-oriented-programming를-이용한-구현"><span class="mr-2">AOP(Aspect Oriented Programming)를 이용한 구현</span><a href="#aopaspect-oriented-programming를-이용한-구현" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>스프링 부트는 어노테이션 기반 AOP 기능을 손쉽게 사용할 수 있게 제공합니다. AOP를 사용하기 위해서는<code class="language-plaintext highlighter-rouge">@EnableAspectJAutoProxy</code>설정을 등록해야 합니다. 코드는 다음과 같습니다.</p><p>AOP 구현체</p><ul><li>JoinPointSpELParser는 직접 정의한 spring Expression Language parser로 <code class="language-plaintext highlighter-rouge">#매개변수명</code>을 통해 값을 접근할 수 있습니다. <code class="language-plaintext highlighter-rouge">@Cacheable</code>, <code class="language-plaintext highlighter-rouge">@PreAuthorize</code>, <code class="language-plaintext highlighter-rouge">@Value</code> 에서 활용하는 것과 동일하며, 직접 구현해 사용했습니다. 자세한 구현은 코드에서 확인해볼 수 있으며 본 내용에서는 생략하도록 하겠습니다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="nd">@Slf4j</span>
<span class="nd">@Aspect</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DistributedLockAspect</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RedissonClient</span> <span class="n">redissonClient</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JoinPointSpELParser</span> <span class="n">joinPointSpELParser</span><span class="o">;</span>

  <span class="nd">@Around</span><span class="o">(</span><span class="s">"@annotation(distributedLock)"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">lock</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">,</span> <span class="nc">DistributedLock</span> <span class="n">distributedLock</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">pa</span> <span class="o">=</span> <span class="n">joinPointSpELParser</span><span class="o">.</span><span class="na">parseSpEL</span><span class="o">(</span><span class="n">pjp</span><span class="o">,</span> <span class="n">distributedLock</span><span class="o">.</span><span class="na">key</span><span class="o">());</span>
    <span class="kd">final</span> <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">distributedLock</span><span class="o">.</span><span class="na">lockConfig</span><span class="o">().</span><span class="na">generateKey</span><span class="o">(</span><span class="n">pa</span><span class="o">);</span>
    <span class="nc">RLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">redissonClient</span><span class="o">.</span><span class="na">getLock</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isAcquired</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">distributedLock</span><span class="o">.</span><span class="na">lockConfig</span><span class="o">().</span><span class="na">waitTime</span><span class="o">,</span> <span class="n">distributedLock</span><span class="o">.</span><span class="na">lockConfig</span><span class="o">().</span><span class="na">leaseTime</span><span class="o">,</span>
          <span class="n">distributedLock</span><span class="o">.</span><span class="na">lockConfig</span><span class="o">().</span><span class="na">timeUnit</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">isAcquired</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RedisConnectionException</span> <span class="n">redisUnavailableException</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="n">redisUnavailableException</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
      <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">isLocked</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">lock</span><span class="o">.</span><span class="na">isHeldByCurrentThread</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>

<span class="nd">@Target</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">DistributedLock</span> <span class="o">{</span>

  <span class="nc">String</span> <span class="nf">key</span><span class="o">();</span>

  <span class="nc">LockConfig</span> <span class="nf">lockConfig</span><span class="o">();</span>

<span class="o">}</span>
</pre></table></code></div></div><p>장점</p><ul><li>비즈니스 로직과 부가 기능의 관심사를 완전히 분리할 수 있습니다. 이를 통해 비즈니스 로직 테스트를 작성하기 더 쉬워집니다.<li>Spring Expression Langugae을 이용해 인자값으로 키값 설정을 간편하게 활용할 수 있습니다.</ul><p>단점</p><ul><li>타 AOP 어노테이션(<code class="language-plaintext highlighter-rouge">@Transactional</code>, <code class="language-plaintext highlighter-rouge">@Async</code> 등)과의 순서(<code class="language-plaintext highlighter-rouge">@Order</code>) 지정 및 동작 예측이 어려워집니다.<li>고질적인 AOP의 단점인 자기 호출(<a href="https://gmoon92.github.io/spring/aop/2019/04/01/spring-aop-mechanism-with-self-invocation.html">self-invocation</a>) 문제가 존재합니다. 오버로딩을 많이 하는 코드에서는 사용하기 어려울 수 있습니다.</ul><h3 id="aop와-함수형-인터페이스를-이용한-구현"><span class="mr-2">AOP와 함수형 인터페이스를 이용한 구현</span><a href="#aop와-함수형-인터페이스를-이용한-구현" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>사실 AOP와 콜백의 장단은 서로 보완관계라고 생각해 상황에 맞게 취사선택하는 방법도 좋은 방법이라고 생각합니다. 사실 AOP 내부에서 함수형 인터페이스를 이용한 구현체를 사용하면 일관된 구현을 통해 락을 활용할 수 있습니다. 이를 <code class="language-plaintext highlighter-rouge">@V2DistributedLock</code>으로 만들어 구현해보겠습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre>
<span class="nd">@Component</span>  
<span class="nd">@Aspect</span>  
<span class="nd">@RequiredArgsConstructor</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">V2DistributedLockAspect</span> <span class="o">{</span>  
  
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JointPointSpELParser</span> <span class="n">jointPointSpELParser</span><span class="o">;</span>  
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RedissonDistributedLockTemplate</span> <span class="n">redissonDistributedLockTemplate</span><span class="o">;</span>  
  
  <span class="nd">@Around</span><span class="o">(</span><span class="s">"@annotation(v2DistributedLock)"</span><span class="o">)</span>  
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">lock</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">,</span> <span class="nc">V2DistributedLock</span> <span class="n">v2DistributedLock</span><span class="o">)</span> <span class="o">{</span>  
    <span class="nc">String</span> <span class="n">parsedKey</span> <span class="o">=</span> <span class="n">jointPointSpELParser</span><span class="o">.</span><span class="na">parseSpEL</span><span class="o">(</span><span class="n">pjp</span><span class="o">,</span> <span class="n">v2DistributedLock</span><span class="o">.</span><span class="na">key</span><span class="o">());</span>  
    <span class="kd">final</span> <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">v2DistributedLock</span><span class="o">.</span><span class="na">lockConfig</span><span class="o">().</span><span class="na">generateKey</span><span class="o">(</span><span class="n">parsedKey</span><span class="o">);</span>  
  
    <span class="k">if</span> <span class="o">(</span><span class="n">v2DistributedLock</span><span class="o">.</span><span class="na">isTransactionEnabled</span><span class="o">())</span> <span class="o">{</span>  
      <span class="k">return</span> <span class="n">redissonDistributedLockTemplate</span><span class="o">.</span><span class="na">executeWithLockAndTransaction</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">v2DistributedLock</span><span class="o">.</span><span class="na">lockConfig</span><span class="o">(),</span> <span class="n">proceed</span><span class="o">(</span><span class="n">pjp</span><span class="o">));</span>  
    <span class="o">}</span>  
  
    <span class="k">return</span> <span class="n">redissonDistributedLockTemplate</span><span class="o">.</span><span class="na">executeWithLock</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">v2DistributedLock</span><span class="o">.</span><span class="na">lockConfig</span><span class="o">(),</span> <span class="n">proceed</span><span class="o">(</span><span class="n">pjp</span><span class="o">));</span>  
  <span class="o">}</span>  
  
  <span class="kd">private</span> <span class="nc">Supplier</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">proceed</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">)</span> <span class="o">{</span>  
    <span class="k">return</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>  
      <span class="k">try</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>  
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>  
      <span class="o">}</span>  
    <span class="o">};</span>  
  <span class="o">}</span>
  
<span class="o">}</span>

<span class="nd">@Target</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>  
<span class="nd">@Retention</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>  
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">V2DistributedLock</span> <span class="o">{</span>  
  
  <span class="nc">String</span> <span class="nf">key</span><span class="o">();</span>  
  
  <span class="nc">LockConfig</span> <span class="nf">lockConfig</span><span class="o">();</span>  
  
  <span class="kt">boolean</span> <span class="nf">isTransactionEnabled</span><span class="o">()</span> <span class="k">default</span> <span class="kc">false</span><span class="o">;</span>  
  
<span class="o">}</span>
</pre></table></code></div></div><p>사용 코드</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">V2ProductService</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ProductRepository</span> <span class="n">productRepository</span><span class="o">;</span>

  <span class="nd">@DistributedLock</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">"#id"</span><span class="o">,</span> <span class="n">lockConfig</span> <span class="o">=</span> <span class="no">PRODUCT_DECREASE</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">Product</span> <span class="nf">decreaseWithAOP</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">quantity</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">productRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">();</span>
    <span class="n">product</span><span class="o">.</span><span class="na">decrease</span><span class="o">(</span><span class="n">quantity</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">productRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@V2DistributedLock</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">"#id"</span><span class="o">,</span> <span class="n">lockConfig</span> <span class="o">=</span> <span class="no">PRODUCT_DECREASE</span><span class="o">,</span> <span class="n">isTransactionEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">Product</span> <span class="nf">decreaseWithAOPV2</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">quantity</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">productRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">();</span>
    <span class="n">product</span><span class="o">.</span><span class="na">decrease</span><span class="o">(</span><span class="n">quantity</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">product</span><span class="o">;</span>
  <span class="o">}</span>

<span class="o">}</span>

</pre></table></code></div></div><h3 id="마무리"><span class="mr-2">마무리</span><a href="#마무리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>일반적인 상황에서 오버헤드는 많이 발생하지 않지만 트래픽이 많아지거나 redis 지연 발생, 혹은 장애 상황이 발생할 때의 고민도 필요합니다. 또한, DB 작업은 테이블의 데이터양이 변화함에 따라 실행 속도가 일관되지 않을 수 있기 때문에 수행 시간에 대한 모니터링, 타임아웃 발생에 대한 모니터링을 진행해 락 시간(<code class="language-plaintext highlighter-rouge">waitTime</code>, <code class="language-plaintext highlighter-rouge">leaseTime</code>)의 유동적인 조절이 필요할 수도 있습니다.</p><p>나아가 본 글에서 동시성에 대해 해결 방법을 소개했지만 근본적으로 동시성이 어디서, 왜 발생하는가에 대한 근본적인 질문을 해보는 것도 방법입니다. 단순히 분산락은 동시 호출이라는 문제를 해결하기 위한 수단일 뿐 절대적인 해결 방법으로만 고려하는건 적절하지 않다고 생각합니다.</p><p>하지만 모든 동시성 상황이 선착순이나 재고 관리와 같은 상황이 아닐 수 있습니다. 간혹 동시성이 일어나는 경우 클라이언트의 잘못된 구현으로 동시 호출이 일어날 수도 있고, UX 상으로 동시성이 일어날 수 있는 설계일 수도 있습니다. 특히 클라이언트의 경우 이벤트 기반으로 동작하는 경우가 많아 동시 호출을 놓치는 경우도 종종 있었습니다.</p><p>모든 예외는 존재하지만 문제의 근본적인 원인과 그 문제의 임팩트에 대해 고민해보고 상황에 맞는 해결책을 제시하고 실행하는게 가장 중요합니다.</p><p>더 자세한 코드들과 테스트 코드들은 다음 링크에서 확인할 수 있습니다. <a href="https://github.com/ChoiEungi/redis-in-actions">https://github.com/ChoiEungi/redis-in-actions</a></p><p>참고 링크</p><ul><li><a href="https://helloworld.kurly.com/blog/distributed-redisson-lock/#3-%EB%B6%84%EC%82%B0%EB%9D%BD%EC%9D%84-%EB%B3%B4%EB%8B%A4-%EC%86%90%EC%89%BD%EA%B2%8C-%EC%82%AC%EC%9A%A9%ED%95%A0-%EC%88%98%EB%8A%94-%EC%97%86%EC%9D%84%EA%B9%8C">https://helloworld.kurly.com/blog/distributed-redisson-lock/#3-%EB%B6%84%EC%82%B0%EB%9D%BD%EC%9D%84-%EB%B3%B4%EB%8B%A4-%EC%86%90%EC%89%BD%EA%B2%8C-%EC%82%AC%EC%9A%A9%ED%95%A0-%EC%88%98%EB%8A%94-%EC%97%86%EC%9D%84%EA%B9%8C</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/development/'>Development</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring-boot/" class="post-tag no-text-decoration" >Spring Boot</a> <a href="/tags/redis/" class="post-tag no-text-decoration" >Redis</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Spring MVC에서 redisson으로 분산락을 구현하는 방법들 - Ruggy Blog&amp;url=https://choieungi.github.io/posts/spring-redis-distributed-lock/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Spring MVC에서 redisson으로 분산락을 구현하는 방법들 - Ruggy Blog&amp;u=https://choieungi.github.io/posts/spring-redis-distributed-lock/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://choieungi.github.io/posts/spring-redis-distributed-lock/&amp;text=Spring MVC에서 redisson으로 분산락을 구현하는 방법들 - Ruggy Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/spring-boot-cahce-error-handling/">Spring Boot에서 CacheManager를 에러 핸들링하는 방법</a><li><a href="/posts/spring-cloud-refresh/">분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법</a><li><a href="/posts/spring-redis-distributed-lock/">Spring MVC에서 redisson으로 분산락을 구현하는 방법들</a><li><a href="/posts/spring-redis-cache-serialization-exception/">Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점</a><li><a href="/posts/querydsl-connection-leak/">querydsl의 transform 메서드에서 발생하는 connection leak 현상</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spring-boot/">Spring Boot</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/thinking/">Thinking</a> <a class="post-tag" href="/tags/redis/">Redis</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/development/">Development</a> <a class="post-tag" href="/tags/gist-%EC%B2%AD%EC%9B%90/">GIST 청원</a> <a class="post-tag" href="/tags/git/">Git</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/spring/">Spring</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/spring-redis-cache-serialization-exception/"><div class="card-body"> <em class="timeago small" data-ts="1702218600" > 2023-12-10 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점</h3><div class="text-muted small"><p> 사내에서 패키지 구조 변경 작업을 하고 배포를 했는데 갑자기 특정 API에서 transaction silently rolled back이 발생했었습니다. 관련해서 확인해보니 DB조회 값을 Dto 객체로 변환해 캐싱한 값을 역직렬화하는 과정에서 문제가 발생했었습니다. 해당 캐시는 월마다 한번씩 바뀌는 주기를 갖는 값으로, 조회가 많은 비율을 차지합니다...</p></div></div></a></div><div class="card"> <a href="/posts/spring-boot-cahce-error-handling/"><div class="card-body"> <em class="timeago small" data-ts="1711851720" > 2024-03-31 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Boot에서 CacheManager를 에러 핸들링하는 방법</h3><div class="text-muted small"><p> 본 글은 아래 링크의 글의 내용과 이어집니다. https://choieungi.github.io/posts/spring-redis-cache-serialization-exception Spring에서 제공하는 @Cacheable을 이용하면 캐쉬를 AOP 기반으로 쉽게 사용할 수 있습니다. 이전 글에서 다뤘듯, 기본적으로 @Cacheable ...</p></div></div></a></div><div class="card"> <a href="/posts/gijol-%ED%9A%8C%EA%B3%A0/"><div class="card-body"> <em class="timeago small" data-ts="1653990180" > 2022-05-31 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Project] Gijol MVP 런칭 회고</h3><div class="text-muted small"><p> 배포 링크: Gijol BE 배경 GIST 청원 프로젝트를 진행하면서 크게 제품의 코드 작성법과 테스트, Operation, Git flow 등을 배울 수 있었다. 이를 청원팀의 팀원으로서 배웠던 점이 많은데 과연 이 배운 것들을 내가 스스로 해나갈 수 있을지에 대해서 의문이 들었다. 이에 대한 중요성과 필요성이 너무나도 중요하게 느껴졌기에...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/spring-redis-cache-serialization-exception/" class="btn btn-outline-primary" prompt="Older"><p>Spring Boot에서 Redis @Cacheable을 사용할 때 주의할 점</p></a> <a href="/posts/spring-cloud-refresh/" class="btn btn-outline-primary" prompt="Newer"><p>분산 시스템 환경에서 Spring Cloud Bus 없이 Spring Cloud Config 프로퍼티 Refresh하는 방법</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/Choieungi">Eungi, Choi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spring-boot/">Spring Boot</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/thinking/">Thinking</a> <a class="post-tag" href="/tags/redis/">Redis</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/development/">Development</a> <a class="post-tag" href="/tags/gist-%EC%B2%AD%EC%9B%90/">GIST 청원</a> <a class="post-tag" href="/tags/git/">Git</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/spring/">Spring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-3R6NSQ6EMQ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-3R6NSQ6EMQ'); }); </script>
